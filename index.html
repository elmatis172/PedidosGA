<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PedidosApp - Test</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .section { 
            margin: 25px 0; 
            padding: 25px; 
            border: none;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .btn { 
            padding: 12px 24px; 
            margin: 6px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .btn.danger { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.danger:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }
        .btn.success { 
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            box-shadow: 0 4px 15px rgba(81, 207, 102, 0.3);
        }
        .btn.success:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(81, 207, 102, 0.4);
        }
        .btn.secondary { 
            background: linear-gradient(135deg, #74c0fc 0%, #339af0 100%);
            box-shadow: 0 4px 15px rgba(116, 192, 252, 0.3);
        }
        .btn.secondary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(116, 192, 252, 0.4);
        }
        
        /* Tabs styles */
        .tabs { 
            display: flex; 
            background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%);
            border-radius: 16px; 
            padding: 8px;
            margin-bottom: 25px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab { 
            padding: 14px 28px; 
            cursor: pointer; 
            border: none; 
            background: none; 
            font-size: 16px; 
            color: #5f6368; 
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            flex: 1;
            text-align: center;
        }
        .tab.active { 
            color: white; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }
        .tab:hover { 
            color: #667eea; 
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Orders table styles */
        .orders-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .orders-table th, .orders-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .orders-table th { background: #f9fafb; font-weight: bold; }
        .orders-table tr:hover { background: #f9fafb; }
        .order-details { background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px; font-size: 14px; }
        
        /* Order cards styles */
        .order-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .order-card:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
            border-color: #667eea;
        }
        
        /* Compact list styles */
        .compact-order-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .compact-order-item:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-color: #667eea;
            transform: translateX(6px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .compact-order-main {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }
        .compact-order-id {
            font-weight: bold;
            color: #1f2937;
            font-size: 14px;
            min-width: 60px;
        }
        .compact-order-customer {
            color: #4b5563;
            font-size: 14px;
            flex: 1;
        }
        .compact-order-total {
            font-weight: bold;
            color: #059669;
            font-size: 16px;
            margin-right: 12px;
        }
        .compact-order-date {
            color: #6b7280;
            font-size: 12px;
            min-width: 80px;
            text-align: right;
        }
        
        /* Expanded details styles */
        .order-details-expanded {
            margin: 8px 0 16px 20px;
            border-left: 3px solid #4f46e5;
            border-radius: 0 8px 8px 0;
            overflow: hidden;
        }
        
        /* Animation for sliding */
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                max-height: 1000px;
                transform: translateY(0);
            }
        }
        
        /* Notification animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f3f4f6;
        }
        .order-id {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }
        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pendiente {
            background: #fef3c7;
            color: #92400e;
        }
        .status-liquidado {
            background: #d1fae5;
            color: #065f46;
        }
        .order-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
        }
        .info-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .info-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
        }
        .order-total {
            font-size: 24px;
            font-weight: bold;
            color: #059669;
            text-align: center;
            margin: 16px 0;
            padding: 12px;
            background: #f0fdf4;
            border-radius: 8px;
        }
        .order-products {
            margin: 16px 0;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .products-title {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .product-item {
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 4px;
            padding: 4px 0;
        }
        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 6px;
        }
        @media (max-width: 768px) {
            .order-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .order-actions {
                flex-direction: column;
            }
        }
        
        .product-form { 
            display: grid; 
            grid-template-columns: 1.3fr 0.9fr 70px 110px 70px 110px 90px; 
            gap: 10px; 
            align-items: center; 
            margin: 12px 0; 
            padding: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .product-form:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: #667eea;
        }
        .form-control { 
            padding: 12px 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-delete {
            padding: 6px 12px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            white-space: nowrap;
        }
        .btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        
        /* Profit Analysis Styles */
        .profit-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e1;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .profit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        .profit-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .profit-value {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .profit-order-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 12px 0;
            transition: all 0.3s ease;
        }
        .profit-order-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .profit-order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
        }
        .profit-order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .profit-detail-item {
            text-align: center;
        }
        .profit-detail-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .profit-detail-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }
        .profit-positive {
            color: #059669 !important;
        }
        .profit-negative {
            color: #dc2626 !important;
        }
        
        @media (max-width: 768px) {
            .product-form { 
                grid-template-columns: 1fr;
                gap: 12px;
                text-align: center;
            }
            .product-form > * {
                grid-column: span 1;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2.5rem; font-weight: 800; text-align: center; margin-bottom: 30px;">🛒 PedidosApp - Test Version</h1>
        
        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('nuevo-pedido', this)">Nuevo Pedido</button>
            <button class="tab" onclick="switchTab('pedidos-lista', this)">Pedidos Pendientes</button>
            <button class="tab" onclick="switchTab('pedidos-liquidados', this)">Pedidos Liquidados</button>
            <button class="tab" onclick="switchTab('analisis-ganancias', this)">Análisis de Ganancias</button>
            <button class="tab" onclick="switchTab('inventario-stock', this)">Inventario & Stock</button>
            <button class="tab" onclick="switchTab('test-conexion', this)">Test Conexión</button>
        </div>

        <!-- Tab Content: Nuevo Pedido -->
        <div id="nuevo-pedido" class="tab-content active">
            <!-- Customer Form -->
            <div class="section">
                <h2 style="color: #374151; font-weight: 700; font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">👤 Datos del Cliente</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="cliente-nombre" class="form-control" placeholder="Nombre *" required>
                    <input type="tel" id="cliente-telefono" class="form-control" placeholder="Teléfono *" required>
                    <input type="email" id="cliente-email" class="form-control" placeholder="Email">
                    <input type="text" id="cliente-direccion" class="form-control" placeholder="Dirección">
                </div>
                
                <!-- Order Date Section -->
                <div style="margin-top: 20px;">
                    <label for="fecha-pedido" style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;">📅 Fecha del Pedido</label>
                    <input type="datetime-local" id="fecha-pedido" class="form-control" style="max-width: 300px;">
                    <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">Si no seleccionas una fecha, se usará la fecha y hora actual</small>
                </div>
            </div>

            <!-- Product Form -->
            <div class="section">
                <h2 style="color: #374151; font-weight: 700; font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">📦 Productos</h2>
                <div style="display: grid; grid-template-columns: 1.3fr 0.9fr 70px 110px 70px 110px 90px; gap: 10px; margin-bottom: 15px; font-weight: 700; padding: 0 16px; color: #374151; font-size: 14px;">
                    <div>Producto</div>
                    <div>Color</div>
                    <div>Cant.</div>
                    <div>Precio</div>
                    <div>IVA</div>
                    <div>Subtotal</div>
                    <div>Acciones</div>
                </div>
                <div id="productos-container">
                    <div class="product-form">
                        <div style="position: relative;">
                            <input type="text" id="producto-input" class="form-control producto-input" placeholder="Escribir o seleccionar producto..." list="productos-datalist" data-index="0">
                            <datalist id="productos-datalist">
                                <option value="">Cargando productos...</option>
                            </datalist>
                        </div>
                        <select id="color-select" class="form-control color-select">
                            <option value="">Seleccionar color...</option>
                        </select>
                        <input type="number" id="cantidad-input" class="form-control cantidad-input" value="1" min="1" data-index="0">
                        <input type="text" id="precio-input" class="form-control precio-input" placeholder="$0">
                        <select id="iva-select" class="form-control iva-select">
                            <option value="0">0%</option>
                            <option value="10.5">10.5%</option>
                            <option value="21">21%</option>
                        </select>
                        <input type="text" id="subtotal-input" class="form-control subtotal-input" readonly placeholder="$0">
                        <button type="button" class="btn-delete" onclick="removeProduct(this)">Eliminar</button>
                    </div>
                </div>
                <button class="btn" onclick="addProduct()">Agregar Producto</button>
            </div>

            <!-- Order Summary -->
            <div class="section">
                <h2 style="color: #374151; font-weight: 700; font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">💰 Total del Pedido</h2>
                <div style="font-size: 24px; font-weight: bold; text-align: center;">
                    $<span id="total-amount">0</span>
                </div>
                
                <!-- Discount Section -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; align-items: center;">
                    <div style="text-align: right; font-weight: bold;">
                        Descuento:
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="discount-input" class="form-control" value="0" min="0" max="100" step="0.1" style="width: 80px;">
                        <span>%</span>
                        <span style="margin-left: 10px; font-weight: bold; color: #ef4444;">-$<span id="discount-amount">0</span></span>
                    </div>
                </div>
                
                <!-- Commission Section -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; align-items: center;">
                    <div style="text-align: right; font-weight: bold;">
                        Comisión Vendedor:
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="commission-input" class="form-control" value="0" min="0" max="100" step="0.1" style="width: 80px;">
                        <span>%</span>
                        <span style="margin-left: 10px; font-weight: bold; color: #3b82f6;">+$<span id="commission-amount">0</span></span>
                    </div>
                </div>
                
                <div style="font-size: 28px; font-weight: bold; text-align: center; border-top: 2px solid #e5e7eb; padding-top: 15px; color: #059669;">
                    Total Final: $<span id="final-total">0</span>
                </div>
                
                <button id="submit-order-btn" class="btn success" style="width: 100%; margin-top: 10px; font-size: 18px;" onclick="createOrder()">Crear Pedido</button>
                <button id="cancel-edit-btn" class="btn secondary" style="width: 100%; margin-top: 10px; font-size: 16px; display: none;" onclick="cancelEdit()">Cancelar Edición</button>
            </div>
        </div>

        <!-- Tab Content: Lista de Pedidos -->
        <div id="pedidos-lista" class="tab-content">
            <div class="section">
                <h2>📋 Pedidos Pendientes</h2>
                <div id="orders-container">
                    <p style="text-align: center; color: #6b7280; font-style: italic;">No hay pedidos pendientes</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Pedidos Liquidados -->
        <div id="pedidos-liquidados" class="tab-content">
            <div class="section">
                <h2>💰 Pedidos Liquidados</h2>
                <div id="liquidated-orders-container">
                    <p style="text-align: center; color: #6b7280; font-style: italic;">No hay pedidos liquidados aún</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Análisis de Ganancias -->
        <div id="analisis-ganancias" class="tab-content">
            <div class="section">
                <h2>📊 Análisis de Ganancias</h2>
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <button class="btn" onclick="calculateProfits()">Calcular Ganancias</button>
                    <select id="profit-filter" class="form-control" style="max-width: 200px;">
                        <option value="all">Todos los pedidos</option>
                        <option value="liquidated">Solo liquidados</option>
                        <option value="pending">Solo pendientes</option>
                    </select>
                </div>
                
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="profit-card">
                        <div class="profit-label">Ganancia Total</div>
                        <div class="profit-value" id="total-profit">$0</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">Margen Promedio</div>
                        <div class="profit-value" id="average-margin">0%</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">Pedidos Analizados</div>
                        <div class="profit-value" id="analyzed-orders">0</div>
                    </div>
                </div>
                
                <div id="profit-analysis-container">
                    <p style="text-align: center; color: #6b7280; font-style: italic;">Haz clic en "Calcular Ganancias" para ver el análisis</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Inventario & Stock -->
        <div id="inventario-stock" class="tab-content">
            <div class="section">
                <h2>📦 Inventario & Stock</h2>
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="btn" onclick="loadInventoryData()">🔄 Actualizar Inventario</button>
                    <button class="btn secondary" onclick="exportInventoryToCSV()">📥 Exportar CSV</button>
                    <div style="margin-left: auto;">
                        <input type="text" id="inventory-search" class="form-control" placeholder="🔍 Buscar producto..." style="max-width: 250px;" onkeyup="filterInventory()">
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="profit-card">
                        <div class="profit-label">Total Productos</div>
                        <div class="profit-value" id="total-products">0</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">Stock Total</div>
                        <div class="profit-value" id="total-stock">0</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">Productos Agotados</div>
                        <div class="profit-value" id="out-of-stock" style="color: #dc2626 !important;">0</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">Valor Inventario</div>
                        <div class="profit-value" id="inventory-value">$0</div>
                    </div>
                </div>
                
                <!-- Inventory Table -->
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <div style="overflow-x: auto;">
                        <table id="inventory-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <tr>
                                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 14px;">Producto</th>
                                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 14px;">Color</th>
                                    <th style="padding: 16px 12px; text-align: center; font-weight: 600; font-size: 14px;">Precio</th>
                                    <th style="padding: 16px 12px; text-align: center; font-weight: 600; font-size: 14px;">Costo</th>
                                    <th style="padding: 16px 12px; text-align: center; font-weight: 600; font-size: 14px;">Stock</th>
                                    <th style="padding: 16px 12px; text-align: center; font-weight: 600; font-size: 14px;">Valor Stock</th>
                                    <th style="padding: 16px 12px; text-align: center; font-weight: 600; font-size: 14px;">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                <tr>
                                    <td colspan="7" style="padding: 40px; text-align: center; color: #6b7280; font-style: italic;">
                                        Haz clic en "Actualizar Inventario" para cargar los datos
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Test Conexión -->
        <div id="test-conexion" class="tab-content">
            <div class="section">
                <h2>Test de Conectividad</h2>
                <button class="btn" onclick="testGoogleSheets()">Probar Google Sheets</button>
                <button class="btn secondary" onclick="loadProductsFromGoogleSheets()" style="background: #3b82f6; border-color: #3b82f6;">📊 Cargar desde Sheets</button>
                <button class="btn secondary" onclick="forceLoadFromGoogleSheets()" style="background: #059669; border-color: #059669; color: white;">🔄 Forzar Carga Completa</button>
                <button class="btn secondary" onclick="debugGoogleSheetsProducts()" style="background: #dc2626; border-color: #dc2626; color: white;">🔍 Debug Sheets</button>
                <button class="btn secondary" onclick="testStorage()">Probar Storage</button>
                <button class="btn" onclick="testFirebaseAfterSetup()" style="background: #f59e0b; border-color: #f59e0b;">🔥 Probar Firebase</button>
                <div id="test-results" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;"></div>
                
                <h3 style="margin-top: 30px; color: #6b7280;">🔥 Configuración de Firebase (DESHABILITADO)</h3>
                <div style="border: 2px solid #6b7280; border-radius: 8px; padding: 16px; background: #f9fafb; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="color: #6b7280; font-weight: bold;">🔥 Firebase:</span>
                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #ef4444; color: white;">
                            ❌ DESHABILITADO
                        </span>
                        <span style="color: #6b7280; font-weight: bold;">📱 No se usa</span>
                    </div>
                    
                    <div style="background: #e5e7eb; border: 1px solid #6b7280; border-radius: 6px; padding: 12px; margin: 12px 0;">
                        <strong>ℹ️ ESTADO ACTUAL:</strong><br>
                        <span style="color: #6b7280;">Firebase está deshabilitado temporalmente. Se está usando Google Sheets como método principal.</span><br><br>
                        <strong>📋 Para reactivar Firebase:</strong><br>
                        1. 🔗 Ve a <a href="https://console.firebase.google.com/" target="_blank" style="color: #1d4ed8;">Firebase Console</a><br>
                        2. 📁 Proyecto: <strong>gestiondepedidos-ebd1e</strong><br>
                        3. 🔥 Firestore Database → Reglas<br>
                        4. 📝 Pegar las reglas de acceso universal<br>
                        5. 💾 Publicar cambios<br>
                        6. 🔧 Cambiar FIREBASE_CONFIG.ENABLED = true en el código
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="showFirebaseRules()" style="background: #f59e0b; border-color: #f59e0b;">
                            📋 Ver Reglas de Firestore
                        </button>
                        <button class="btn secondary" onclick="testFirebaseAfterSetup()" style="font-size: 12px;">
                            🧪 Probar Firebase
                        </button>
                        <button class="btn secondary" onclick="loadOrdersFromFirebase()" style="font-size: 12px;">
                            📥 Cargar Pedidos
                        </button>
                        <button class="btn secondary" onclick="forceReloadProducts()" style="font-size: 12px; background: #dc2626; border-color: #dc2626;">
                            🔄 Recargar 25 Productos
                        </button>
                    </div>
                    
                    <p style="font-size: 12px; color: #92400e; margin-top: 12px; margin-bottom: 0;">
                        💡 <strong>Ventajas de Firebase:</strong> Sincronización automática, tiempo real, funciona sin problemas en cualquier computadora
                    </p>
                </div>
                
                <h3 style="margin-top: 30px; color: #3b82f6;">📊 Configuración de Google Sheets (ACTIVO)</h3>
                <div style="border: 2px solid #3b82f6; border-radius: 8px; padding: 16px; background: #eff6ff; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="color: #1e40af; font-weight: bold;">📊 Google Sheets:</span>
                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #10b981; color: white;">
                            ✅ HABILITADO
                        </span>
                        <span style="color: #1e40af; font-weight: bold;">📱 Método Principal</span>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 12px; margin: 12px 0;" id="config-status">
                        <strong>📖 Estado actual:</strong><br>
                        <span id="status-lectura">⏳ Verificando...</span><br>
                        <span id="status-escritura">⏳ Verificando...</span><br>
                        💡 <strong>Motivo:</strong> <span id="status-reason">Verificando configuración...</span>
                    </div>
                    
                    <p style="color: #1e40af; font-weight: bold; margin-bottom: 12px;">
                        📋 Para habilitar escritura completa, necesitas configurar OAuth2 o una Service Account
                    </p>
                    
                    <div style="background: white; border-radius: 6px; padding: 12px; margin: 12px 0; font-family: monospace; font-size: 12px; border: 1px solid #bfdbfe;">
                        <strong>Estructura requerida para la hoja "pedidos" (cuando se habilite escritura):</strong><br>
                        A1: ID | B1: Fecha | C1: Cliente | D1: Teléfono | E1: Email | F1: Total | G1: Estado | H1: Productos
                    </div>
                    
                    <button class="btn" onclick="testPedidosSheet()" style="background: #3b82f6; border-color: #3b82f6; margin-right: 10px;">
                        🔍 Verificar Hoja "pedidos"
                    </button>
                    <button class="btn secondary" onclick="showGoogleSheetsInstructions()" style="font-size: 12px;">
                        📖 Ver Instrucciones
                    </button>
                </div>
                
                <h3 style="margin-top: 30px; color: #dc2626;">🚨 Herramientas de Emergencia</h3>
                <div style="border: 2px solid #dc2626; border-radius: 8px; padding: 16px; background: #fef2f2;">
                    <p style="color: #dc2626; font-weight: bold; margin-bottom: 12px;">
                        ⚠️ Usar solo si los pedidos no aparecen o hay problemas de persistencia
                    </p>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
                        <button class="btn" onclick="emergencyDiagnosis()" style="background: #f59e0b; border-color: #f59e0b;">
                            🔍 Diagnóstico Completo
                        </button>
                        <button class="btn" onclick="attemptDataRecovery()" style="background: #059669; border-color: #059669;">
                            🔄 Recuperar Datos
                        </button>
                        <button class="btn" onclick="emergencyRepair()" style="background: #dc2626; border-color: #dc2626;">
                            🔧 Reparación de Emergencia
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn secondary" onclick="debugLocalStorage()" style="font-size: 12px;">
                            🐛 Debug localStorage
                        </button>
                        <button class="btn secondary" onclick="forceSaveOrders()" style="font-size: 12px;">
                            💾 Forzar Guardado
                        </button>
                        <button class="btn secondary" onclick="forceLoadOrders()" style="font-size: 12px;">
                            📥 Forzar Carga
                        </button>
                        <button class="btn secondary" onclick="syncWithGoogleSheets()" style="font-size: 12px;">
                            ☁️ Sincronizar Sheets
                        </button>
                        <button class="btn secondary" onclick="showConfigDebug()" style="font-size: 12px;">
                            🔍 Debug Config
                        </button>
                        <button class="btn secondary" onclick="createTestOrder()" style="font-size: 12px;">
                            🎯 Crear Pedido Prueba
                        </button>
                        <button class="btn secondary" onclick="checkSyncQueue()" style="font-size: 12px;">
                            📋 Ver Cola Sync
                        </button>
                        <button class="btn secondary" onclick="forceSyncQueue()" style="font-size: 12px;">
                            🔄 Forzar Sync
                        </button>
                    </div>
                    
                    <div id="queue-status" style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 4px solid #3b82f6; display: none;">
                        <h4 style="margin: 0 0 8px 0; color: #3b82f6; font-size: 14px;">📋 Estado de la Cola de Sincronización</h4>
                        <div id="queue-details" style="font-size: 12px; color: #6b7280;"></div>
                    </div>
                    
                    <p style="font-size: 12px; color: #6b7280; margin-top: 12px; margin-bottom: 0;">
                        💡 Tip: Abre la consola del navegador (F12) para ver los resultados detallados de estos comandos
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let products = [];
        let orders = []; // Store all created orders
        let editingOrderId = null; // Track if we're editing an order
        let currentOrder = {
            customer: {},
            products: [],
            total: 0
        };

        // Utility function to format currency values
        function formatCurrency(value) {
            try {
                // Handle different input types
                let numericValue;
                
                if (typeof value === 'string') {
                    // Remove any existing currency symbols and formatting, keep only digits
                    const cleanValue = value.replace(/[^0-9]/g, '');
                    numericValue = parseFloat(cleanValue) || 0;
                } else {
                    numericValue = parseFloat(value) || 0;
                }
                
                // Return 0 if not a valid number
                if (isNaN(numericValue) || numericValue === 0) {
                    return '0';
                }
                
                // Format with Argentine locale (uses . for thousands, , for decimals)
                // For values >= 1000, this will show thousands separators
                return numericValue.toLocaleString('es-AR', { 
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                });
            } catch (error) {
                console.warn('Error formatting currency:', value, error);
                return '0';
            }
        }

        // Utility function to parse currency values from formatted text
        function parseCurrency(formattedValue) {
            try {
                if (!formattedValue) return 0;
                
                // Convert to string and remove all non-digit characters
                const cleanValue = formattedValue.toString().replace(/[^0-9]/g, '');
                const numericValue = parseFloat(cleanValue) || 0;
                
                console.log('🔍 parseCurrency:', formattedValue, '->', numericValue);
                return numericValue;
            } catch (error) {
                console.warn('Error parsing currency:', formattedValue, error);
                return 0;
            }
        }

        // Firebase helper functions
        function generateOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const orderNumber = `${year}${month}${day}${random}`;
            console.log('🆔 Generated order number:', orderNumber, '(type:', typeof orderNumber, ')');
            return orderNumber;
        }

        // Load orders from Firebase
        async function loadOrdersFromFirebase() {
            try {
                console.log('📥 Cargando pedidos desde Firebase...');
                const pedidos = await window.firebaseService.loadPedidos();
                
                orders = pedidos;
                console.log(`✅ ${orders.length} pedidos cargados desde Firebase`);
                
                displayOrdersList();
                displayLiquidatedOrdersList();
                
            } catch (error) {
                console.error('❌ Error cargando desde Firebase:', error);
                // Fallback to localStorage
                loadOrders();
            }
        }

        // Update order status in Firebase
        async function updateOrderStatusFirebase(orderId, newStatus) {
            try {
                console.log(`🔄 Actualizando estado a: ${newStatus}`);
                const result = await window.firebaseService.updatePedidoStatus(orderId, newStatus);
                
                if (result.success) {
                    console.log('✅ Estado actualizado en Firebase');
                    // Reload orders to update UI
                    await loadOrdersFromFirebase();
                } else {
                    console.error('❌ Error actualizando estado:', result.error);
                }
                
                return result.success;
            } catch (error) {
                console.error('❌ Error en updateOrderStatusFirebase:', error);
                return false;
            }
        }

        // Tab management - FUNCIÓN PRINCIPAL
        function switchTab(tabId, targetElement = null) {
            try {
                console.log('🔄 switchTab called:', tabId);
                
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab content
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log('Tab activado:', tabId);
                } else {
                    console.error('No se encontró el tab:', tabId);
                }
                
                // Add active class to clicked tab
                if (targetElement) {
                    targetElement.classList.add('active');
                } else {
                    // Find the tab by onclick attribute if no target provided
                    const tabButtons = document.querySelectorAll('.tab');
                    tabButtons.forEach(tab => {
                        const onclick = tab.getAttribute('onclick');
                        if (onclick && onclick.includes(tabId)) {
                            tab.classList.add('active');
                        }
                    });
                }
                
                // Load data for specific tabs - SIMPLIFIED
                if (tabId === 'pedidos-lista') {
                    console.log('🔄 Loading pending orders...');
                    console.log('- Current orders in memory:', orders);
                    console.log('- Orders length:', orders.length);
                    
                    // Force reload from localStorage to be sure
                    const savedOrders = localStorage.getItem('pedidos');
                    if (savedOrders) {
                        try {
                            orders = JSON.parse(savedOrders);
                            window.orders = orders;
                            console.log('- Reloaded orders from localStorage:', orders);
                        } catch (e) {
                            console.error('- Error reloading orders:', e);
                        }
                    }
                    
                    // Display immediately
                    setTimeout(() => {
                        console.log('- Calling displayOrdersList with orders:', orders);
                        displayOrdersList();
                    }, 10);
                    
                } else if (tabId === 'pedidos-liquidados') {
                    console.log('🔄 Loading liquidated orders...');
                    
                    // Force reload from localStorage
                    const savedOrders = localStorage.getItem('pedidos');
                    if (savedOrders) {
                        try {
                            orders = JSON.parse(savedOrders);
                            window.orders = orders;
                        } catch (e) {
                            console.error('Error reloading orders:', e);
                        }
                    }
                    
                    setTimeout(() => displayLiquidatedOrdersList(), 10);
                    
                } else if (tabId === 'analisis-ganancias') {
                    setTimeout(() => calculateProfits(), 100);
                } else if (tabId === 'inventario-stock') {
                    setTimeout(() => loadInventoryData(), 100);
                } else if (tabId === 'nuevo-pedido') {
                    // ⭐ Auto-check products when switching to nuevo-pedido
                    console.log('🔄 Cambiando a nuevo-pedido - verificando productos...');
                    autoCheckProducts();
                    
                    // ⭐ CRÍTICO: Forzar actualización de dropdowns al cambiar a nuevo-pedido
                    setTimeout(() => {
                        console.log('🔄 Forzando actualización de dropdowns al cambiar a nuevo-pedido...');
                        
                        // ⭐ SINCRONIZACIÓN: Asegurar que products y window.products estén sincronizados
                        if (window.products && window.products.length > 0 && products.length !== window.products.length) {
                            products = window.products;
                            console.log('🔄 SWITCH TAB: Variables sincronizadas - products:', products.length);
                        }
                        
                        loadProductsToSelect();
                        console.log('✅ Dropdowns actualizados al cambiar a nuevo-pedido');
                    }, 200);
                }
                
            } catch (globalError) {
                console.error('🚨 ERROR EN switchTab:', globalError);
                alert(`🚨 Error cambiando de pestaña: ${globalError.message}`);
            }
        }

        // Verificar que la función está definida
        console.log('switchTab definida:', typeof switchTab);

        // Google Sheets Configuration - HABILITADO COMO PRINCIPAL
        const GOOGLE_CONFIG = {
            SHEETS_ID: "1yVjDyz7aXnW5BIyVoe3y7bFsrJGR3pVUwtnI43PprAg",
            API_KEY: "AIzaSyCfPL8M1wIFMKxBOkTPsuwAbiyEMXk8Zvw",
            ORDERS_RANGE: "app!A:H", // Nueva hoja "app" para pedidos
            STOCK_RANGE: "stock!A1:F1000",
            ENABLED: true, // HABILITADO como método principal
            WRITE_ENABLED: true, // Habilitada también la escritura
            ERROR_COUNT: 0,
            MAX_ERRORS: 5 // Auto-disable after 5 consecutive errors
        };

        // Auto-reload configuration
        let lastProductLoad = 0;
        const PRODUCT_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes in milliseconds

        // Auto-check for product updates
        async function autoCheckProducts() {
            try {
                console.log('🔄 AUTO-CHECK: Verificando productos...');
                
                // Verify Google Sheets is enabled and configured
                if (!GOOGLE_CONFIG.ENABLED) {
                    console.log('⚠️ AUTO-CHECK: Google Sheets deshabilitado, saltando auto-check');
                    return;
                }
                
                if (!GOOGLE_CONFIG.SHEETS_ID || !GOOGLE_CONFIG.API_KEY) {
                    console.log('⚠️ AUTO-CHECK: Configuración de Google Sheets incompleta, saltando auto-check');
                    return;
                }
                
                const now = Date.now();
                const timeSinceLastLoad = now - lastProductLoad;
                
                console.log('- Last load:', new Date(lastProductLoad).toLocaleTimeString());
                console.log('- Time since last load:', timeSinceLastLoad / 1000 / 60, 'minutes');
                console.log('- Current products count:', products.length);
                
                // If more than 5 minutes have passed or no products loaded, reload
                if (timeSinceLastLoad > PRODUCT_REFRESH_INTERVAL || products.length === 0) {
                    console.log('🔄 AUTO-CHECK: Reloading products automatically...');
                    try {
                        await forceLoadFromGoogleSheets();
                        lastProductLoad = now;
                        console.log('✅ AUTO-CHECK: Products auto-reloaded successfully');
                        
                        // ⭐ CRÍTICO: Actualizar dropdowns después del auto-check
                        // ⭐ SINCRONIZACIÓN: Asegurar que products y window.products estén sincronizados
                        if (window.products && window.products.length > 0) {
                            products = window.products;
                            console.log('🔄 AUTO-CHECK: Variables sincronizadas - products:', products.length);
                        }
                        
                        setTimeout(() => {
                            loadProductsToSelect();
                            console.log('✅ AUTO-CHECK: Dropdowns actualizados');
                        }, 300);
                        
                    } catch (error) {
                        console.error('❌ AUTO-CHECK: Error auto-reloading products:', error);
                        // No mostrar alert aquí para evitar interrumpir al usuario
                    }
                } else {
                    console.log('✅ AUTO-CHECK: Products are recent, no reload needed');
                }
                
            } catch (error) {
                console.error('❌ AUTO-CHECK: Error general en autoCheckProducts:', error);
                // No mostrar alert aquí para evitar interrumpir al usuario
            }
        }

        // Firebase Configuration - DESHABILITADO
        const FIREBASE_CONFIG = {
            ENABLED: false,
            WRITE_ENABLED: false,
            REAL_TIME: false
        };

        // Update configuration status display
        function updateConfigStatus() {
            const statusLectura = document.getElementById('status-lectura');
            const statusEscritura = document.getElementById('status-escritura');
            const statusReason = document.getElementById('status-reason');
            
            if (statusLectura) {
                if (GOOGLE_CONFIG.ENABLED) {
                    statusLectura.innerHTML = '✅ <strong>Lectura habilitada:</strong> Los productos se cargan desde Google Sheets (MÉTODO PRINCIPAL)';
                } else {
                    statusLectura.innerHTML = '❌ <strong>Lectura deshabilitada:</strong> Usando productos por defecto';
                }
            }
            
            if (statusEscritura) {
                if (GOOGLE_CONFIG.ENABLED && GOOGLE_CONFIG.WRITE_ENABLED) {
                    statusEscritura.innerHTML = '✅ <strong>Escritura habilitada:</strong> Los pedidos se sincronizan con Google Sheets';
                } else {
                    statusEscritura.innerHTML = '⚠️ <strong>Escritura deshabilitada:</strong> Los pedidos se guardan solo localmente';
                }
            }
            
            if (statusReason) {
                if (GOOGLE_CONFIG.ENABLED && GOOGLE_CONFIG.WRITE_ENABLED) {
                    statusReason.innerHTML = 'Google Sheets configurado como método principal - sincronización bidireccional activa';
                } else if (GOOGLE_CONFIG.ENABLED && !GOOGLE_CONFIG.WRITE_ENABLED) {
                    statusReason.innerHTML = 'Solo lectura habilitada - escritura desactivada por configuración';
                } else {
                    statusReason.innerHTML = 'Google Sheets completamente deshabilitado';
                }
            }
            
            console.log('📊 Estado de configuración actualizado:');
            console.log('- GOOGLE_CONFIG.ENABLED:', GOOGLE_CONFIG.ENABLED);
            console.log('- GOOGLE_CONFIG.WRITE_ENABLED:', GOOGLE_CONFIG.WRITE_ENABLED);
            console.log('- FIREBASE_CONFIG.ENABLED:', FIREBASE_CONFIG.ENABLED);
        }

        // Fast order creation queue
        let orderQueue = [];
        let isProcessingQueue = false;

        // Test Google Sheets API
        async function testGoogleSheets() {
            const results = document.getElementById('test-results');
            if (results) {
                results.innerHTML = '🔄 Probando conexión con Google Sheets...';
            }
            
            console.log('🔗 Intentando cargar productos desde Google Sheets...');
            console.log('- GOOGLE_CONFIG.ENABLED:', GOOGLE_CONFIG.ENABLED);
            
            if (!GOOGLE_CONFIG.ENABLED) {
                const message = `⚠️ Google Sheets deshabilitado.<br>
                                 Cargando productos por defecto...`;
                if (results) results.innerHTML = message;
                console.log('⚠️ Google Sheets deshabilitado, cargando productos por defecto');
                loadDefaultProducts();
                return;
            }
            
            try {
                // Usar la función de carga de productos
                await loadProductsFromGoogleSheets();
                
                const message = `✅ Google Sheets conectado exitosamente!<br>📊 Se cargaron ${products.length} productos<br>🎨 ${window.availableColors?.length || 0} colores disponibles`;
                if (results) results.innerHTML = message;
                
            } catch (error) {
                console.error('❌ Error conectando con Google Sheets:', error);
                const message = `❌ Error conectando con Google Sheets: ${error.message}<br>
                                💡 Revisa que la hoja sea pública o que la API Key tenga permisos correctos<br>
                                📦 Cargando productos por defecto...`;
                if (results) results.innerHTML = message;
                
                // Load default products as fallback
                loadDefaultProducts();
            }
        }

        // Fast write to Google Sheets - IMMEDIATE response
        async function writeOrderToGoogleSheets(order) {
            console.log('🔍 DEBUG writeOrderToGoogleSheets - Estado de configuración:');
            console.log('- GOOGLE_CONFIG.ENABLED:', GOOGLE_CONFIG.ENABLED);
            console.log('- GOOGLE_CONFIG.WRITE_ENABLED:', GOOGLE_CONFIG.WRITE_ENABLED);
            console.log('- Condición (!ENABLED || !WRITE_ENABLED):', (!GOOGLE_CONFIG.ENABLED || !GOOGLE_CONFIG.WRITE_ENABLED));
            
            if (!GOOGLE_CONFIG.ENABLED || !GOOGLE_CONFIG.WRITE_ENABLED) {
                console.log('📝 Google Sheets escritura deshabilitada - guardando solo localmente');
                return { success: true, offline: true };
            }

            try {
                console.log('📝 Escribiendo pedido a Google Sheets (MODO RÁPIDO)...');
                
                // Prepare row data for Google Sheets
                const rowData = [
                    order.id.toString(),
                    order.date,
                    order.customer.name,
                    order.customer.phone,
                    order.customer.email || '',
                    order.total,
                    order.status,
                    JSON.stringify(order.products) // Store products as JSON
                ];
                
                // Use Google Sheets API v4 for direct write
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SHEETS_ID}/values/${GOOGLE_CONFIG.ORDERS_RANGE}:append?valueInputOption=RAW&key=${GOOGLE_CONFIG.API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        values: [rowData]
                    })
                });
                
                if (response.ok) {
                    console.log('✅ Pedido escrito exitosamente en Google Sheets');
                    return { success: true };
                } else {
                    throw new Error(`Error escribiendo a Google Sheets: ${response.status} - ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('❌ Error escribiendo a Google Sheets:', error);
                // Add to queue for retry
                orderQueue.push({ action: 'write', data: order });
                return { success: false, error: error.message };
            }
        }

        // Fast stock update - Background process
        async function updateStockBackground(orderProducts) {
            if (!GOOGLE_CONFIG.ENABLED || !GOOGLE_CONFIG.WRITE_ENABLED) {
                console.log('📊 Google Sheets escritura deshabilitada - no se actualiza stock');
                return { success: true, offline: true };
            }

            try {
                console.log('📊 Actualizando stock en segundo plano...');
                
                // First, get current stock data
                const stockUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SHEETS_ID}/values/${GOOGLE_CONFIG.STOCK_RANGE}?key=${GOOGLE_CONFIG.API_KEY}`;
                const stockResponse = await fetch(stockUrl);
                
                if (!stockResponse.ok) {
                    throw new Error(`Error obteniendo stock: ${stockResponse.status}`);
                }
                
                const stockData = await stockResponse.json();
                
                if (!stockData.values || stockData.values.length === 0) {
                    throw new Error('No hay datos de stock disponibles');
                }
                
                // Process stock updates
                const updates = [];
                for (let product of orderProducts) {
                    const productName = product.product.trim();
                    const productColor = product.color.trim();
                    const quantity = parseInt(product.quantity) || 0;
                    
                    // Find the product row in stock data
                    for (let i = 1; i < stockData.values.length; i++) {
                        const row = stockData.values[i];
                        if (row[0] && row[1] && 
                            row[0].toLowerCase() === productName.toLowerCase() && 
                            row[1].toLowerCase() === productColor.toLowerCase()) {
                            
                            const currentStock = parseInt(row[2]) || 0;
                            const newStock = Math.max(0, currentStock - quantity);
                            
                            // Prepare update
                            updates.push({
                                range: `stock!C${i + 1}`,
                                values: [[newStock]]
                            });
                            
                            console.log(`📦 ${productName} (${productColor}): ${currentStock} → ${newStock}`);
                        }
                    }
                }
                
                // Batch update stock
                if (updates.length > 0) {
                    const batchUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SHEETS_ID}/values:batchUpdate?key=${GOOGLE_CONFIG.API_KEY}`;
                    
                    const batchResponse = await fetch(batchUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            valueInputOption: 'RAW',
                            data: updates
                        })
                    });
                    
                    if (batchResponse.ok) {
                        console.log(`✅ Stock actualizado exitosamente (${updates.length} productos)`);
                        
                        // Reload products data to reflect changes
                        setTimeout(() => {
                            if (GOOGLE_CONFIG.ENABLED) testGoogleSheets();
                        }, 1000);
                        
                        return { success: true, updated: updates.length };
                    } else {
                        throw new Error(`Error en batch update: ${batchResponse.status} - ${batchResponse.statusText}`);
                    }
                }
                
                return { success: true, updated: 0 };
                
            } catch (error) {
                console.error('❌ Error actualizando stock:', error);
                // Add to queue for retry only if it's a temporary error
                if (!error.message.includes('401') && !error.message.includes('403')) {
                    orderQueue.push({ action: 'stock', data: orderProducts });
                }
                return { success: false, error: error.message };
            }
        }

        // Process queue in background
        async function processQueue() {
            if (isProcessingQueue || orderQueue.length === 0) return;
            
            isProcessingQueue = true;
            console.log(`🔄 Procesando cola de operaciones (${orderQueue.length} pendientes)...`);
            
            while (orderQueue.length > 0) {
                const operation = orderQueue.shift();
                
                try {
                    if (operation.action === 'write') {
                        await writeOrderToGoogleSheets(operation.data);
                    } else if (operation.action === 'stock') {
                        await updateStockBackground(operation.data);
                    }
                    
                    // Small delay between operations
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error('❌ Error procesando operación en cola:', error);
                    // Don't re-add to queue to avoid infinite loops
                }
            }
            
            isProcessingQueue = false;
            console.log('✅ Cola de operaciones completada');
        }

        // Parse Google Sheets data
        function parseGoogleSheetsData(values) {
            const products = [];
            const allColors = new Set();
            
            console.log('🔄 Parseando datos de Google Sheets...');
            console.log('📊 Total de filas a procesar:', values.length - 1);
            
            for (let i = 1; i < values.length; i++) {
                const row = values[i];
                if (row.length < 4) {
                    console.log(`⚠️ Fila ${i} omitida - insuficientes columnas:`, row.length);
                    continue; // Need at least A, B, C, D columns
                }
                
                // Only log every 20th row to avoid console spam
                if (i % 20 === 0 || i <= 5) {
                    console.log(`📝 Procesando fila ${i}:`, row);
                }
                
                // Parse price correctly from Google Sheets
                let price = 0;
                const rawPrice = row[3]; // Column D for price
                
                if (rawPrice !== undefined && rawPrice !== null) {
                    if (typeof rawPrice === 'number') {
                        // Use the number directly from Google Sheets
                        price = rawPrice;
                        
                    } else {
                        // Handle string prices with proper parsing
                        let priceStr = rawPrice.toString();
                        
                        // Remove currency symbols and spaces
                        priceStr = priceStr.replace(/[$\s]/g, '');
                        
                        // Handle different decimal separators
                        if (priceStr.includes(',') && priceStr.includes('.')) {
                            // Has both comma and dot - determine which is decimal
                            const lastComma = priceStr.lastIndexOf(',');
                            const lastDot = priceStr.lastIndexOf('.');
                            
                            if (lastDot > lastComma) {
                                // US format: 12,345.67
                                priceStr = priceStr.replace(/,/g, '');
                            } else {
                                // European format: 12.345,67
                                priceStr = priceStr.replace(/\./g, '').replace(',', '.');
                            }
                        } else if (priceStr.includes(',')) {
                            // Only comma - could be thousands or decimal
                            const commaPos = priceStr.lastIndexOf(',');
                            if (priceStr.length - commaPos <= 3) {
                                // Likely decimal separator
                                priceStr = priceStr.replace(',', '.');
                            } else {
                                // Thousands separator
                                priceStr = priceStr.replace(/,/g, '');
                            }
                        }
                        
                        price = parseFloat(priceStr) || 0;
                    }
                }

                const productName = (row[0] || 'Sin nombre').toString().trim();
                const color = (row[1] || 'Sin color').toString().trim();
                
                // Add color to the set of all colors
                if (color && color !== 'Sin color') {
                    allColors.add(color);
                }
                
                // Parse cost from column F (5 digits)
                let cost = 0;
                const rawCost = row[5]; // Column F for cost
                
                if (rawCost !== undefined && rawCost !== null) {
                    if (typeof rawCost === 'number') {
                        cost = rawCost;
                    } else {
                        cost = parseFloat(rawCost.toString().replace(/[^\d.]/g, '')) || 0;
                    }
                }
                
                const product = {
                    id: 'PROD_' + i,
                    name: productName,
                    color: color,
                    price: price,
                    cost: cost, // Use cost directly from column F
                    stock: parseInt(row[2]) || 0, // Column C for stock
                    category: (row[4] || 'General').toString().trim() // Column E for category
                };
                
                // Only log detailed product info for first few or every 20th
                if (i <= 5 || i % 20 === 0) {
                    console.log(`✅ Producto ${i} parseado:`, product);
                }
                
                products.push(product);
            }
            
            console.log(`🎉 Procesamiento completado: ${products.length} productos parseados de ${values.length - 1} filas`);
            
            // Store all available colors globally
            window.availableColors = Array.from(allColors);
            console.log('🎨 Colores disponibles:', window.availableColors.length, 'colores únicos');
            
            return products;
        }

        // Load default products if Google Sheets fails
        function loadDefaultProducts() {
            products = [
                { id: 'P1', name: 'Remera Básica', color: 'Blanco', price: 2500, cost: 1500, stock: 50, category: 'Remeras' },
                { id: 'P2', name: 'Remera Básica', color: 'Negro', price: 2500, cost: 1500, stock: 30, category: 'Remeras' },
                { id: 'P3', name: 'Remera Básica', color: 'Gris', price: 2500, cost: 1500, stock: 25, category: 'Remeras' },
                { id: 'P4', name: 'Jean Clásico', color: 'Azul', price: 4500, cost: 2700, stock: 20, category: 'Pantalones' },
                { id: 'P5', name: 'Jean Clásico', color: 'Negro', price: 4500, cost: 2700, stock: 15, category: 'Pantalones' },
                { id: 'P6', name: 'Buzo Capucha', color: 'Negro', price: 3800, cost: 2300, stock: 10, category: 'Buzos' },
                { id: 'P7', name: 'Buzo Capucha', color: 'Gris', price: 3800, cost: 2300, stock: 12, category: 'Buzos' },
                { id: 'P8', name: 'Campera Jean', color: 'Azul', price: 5200, cost: 3100, stock: 8, category: 'Camperas' },
                { id: 'P9', name: 'Zapatillas Deportivas', color: 'Blanco', price: 6800, cost: 4000, stock: 15, category: 'Calzado' },
                { id: 'P10', name: 'Zapatillas Deportivas', color: 'Negro', price: 6800, cost: 4000, stock: 12, category: 'Calzado' },
                { id: 'P11', name: 'Jogger', color: 'Negro', price: 3200, cost: 1900, stock: 18, category: 'Pantalones' },
                { id: 'P12', name: 'Jogger', color: 'Gris', price: 3200, cost: 1900, stock: 22, category: 'Pantalones' },
                { id: 'P13', name: 'Polo', color: 'Blanco', price: 2800, cost: 1700, stock: 14, category: 'Remeras' },
                { id: 'P14', name: 'Polo', color: 'Negro', price: 2800, cost: 1700, stock: 16, category: 'Remeras' },
                { id: 'P15', name: 'Shorts', color: 'Azul', price: 2200, cost: 1300, stock: 20, category: 'Pantalones' },
                // Productos adicionales para expandir el catálogo
                { id: 'P16', name: 'Campera Deportiva', color: 'Negro', price: 4800, cost: 2900, stock: 8, category: 'Camperas' },
                { id: 'P17', name: 'Campera Deportiva', color: 'Azul', price: 4800, cost: 2900, stock: 6, category: 'Camperas' },
                { id: 'P18', name: 'Pantalón Chino', color: 'Beige', price: 3800, cost: 2300, stock: 15, category: 'Pantalones' },
                { id: 'P19', name: 'Pantalón Chino', color: 'Negro', price: 3800, cost: 2300, stock: 12, category: 'Pantalones' },
                { id: 'P20', name: 'Hoodie Oversize', color: 'Gris', price: 4200, cost: 2500, stock: 8, category: 'Buzos' },
                { id: 'P21', name: 'Hoodie Oversize', color: 'Negro', price: 4200, cost: 2500, stock: 10, category: 'Buzos' },
                { id: 'P22', name: 'Bermuda', color: 'Azul', price: 2800, cost: 1700, stock: 25, category: 'Pantalones' },
                { id: 'P23', name: 'Bermuda', color: 'Verde', price: 2800, cost: 1700, stock: 20, category: 'Pantalones' },
                { id: 'P24', name: 'Remera Estampada', color: 'Blanco', price: 2800, cost: 1700, stock: 30, category: 'Remeras' },
                { id: 'P25', name: 'Remera Estampada', color: 'Negro', price: 2800, cost: 1700, stock: 28, category: 'Remeras' }
            ];
            
            window.availableColors = ['Blanco', 'Negro', 'Gris', 'Azul', 'Verde', 'Beige'];
            console.log('📦 Productos por defecto cargados:', products.length);
            loadProductsToSelect();
            
            // Guardar productos en Firebase si está disponible
            saveProductsToFirebase();
        }
        
        // Guardar productos en Firebase
        async function saveProductsToFirebase() {
            if (!window.firebaseService || !window.firebaseService.isInitialized) {
                console.log('🔄 Firebase no disponible, productos guardados solo localmente');
                return;
            }
            
            try {
                console.log(`💾 Guardando ${products.length} productos en Firebase...`);
                
                // Verificar si ya existen productos en Firebase
                const existingProducts = await window.firebaseService.loadProducts();
                
                if (existingProducts && existingProducts.length >= products.length) {
                    console.log(`✅ Ya hay ${existingProducts.length} productos en Firebase, saltando guardado`);
                    return;
                }
                
                let savedCount = 0;
                for (const product of products) {
                    try {
                        await window.firebaseService.saveProduct(product);
                        savedCount++;
                        console.log(`💾 Producto guardado ${savedCount}/${products.length}: ${product.name} - ${product.color}`);
                    } catch (error) {
                        console.error(`❌ Error guardando producto ${product.id}:`, error);
                    }
                }
                
                console.log(`✅ ${savedCount}/${products.length} productos guardados en Firebase exitosamente`);
            } catch (error) {
                console.error('❌ Error guardando productos en Firebase:', error);
            }
        }
        
        // Cargar productos desde Firebase
        async function loadProductsFromFirebase() {
            if (!window.firebaseService || !window.firebaseService.isInitialized) {
                console.log('🔄 Firebase no disponible, probando Google Sheets...');
                if (GOOGLE_CONFIG.ENABLED) {
                    await loadProductsFromGoogleSheets();
                } else {
                    loadDefaultProducts();
                }
                return;
            }
            
            try {
                console.log('📥 Cargando productos desde Firebase...');
                const productsFromFirebase = await window.firebaseService.loadProducts();
                
                if (productsFromFirebase && productsFromFirebase.length >= 20) {
                    products = productsFromFirebase;
                    
                    // Extract available colors
                    const allColors = new Set();
                    products.forEach(product => {
                        if (product.color && product.color !== 'Sin color') {
                            allColors.add(product.color);
                        }
                    });
                    window.availableColors = Array.from(allColors);
                    
                    console.log(`✅ ${products.length} productos cargados desde Firebase`);
                    loadProductsToSelect();
                } else {
                    console.log(`📦 Solo ${productsFromFirebase?.length || 0} productos en Firebase. Probando Google Sheets como fallback...`);
                    if (GOOGLE_CONFIG.ENABLED) {
                        await loadProductsFromGoogleSheets();
                    } else {
                        console.log('📦 Google Sheets deshabilitado, cargando catálogo por defecto...');
                        loadDefaultProducts(); // This will load 25 products and save to Firebase
                    }
                }
                
            } catch (error) {
                console.error('❌ Error cargando productos desde Firebase:', error);
                console.log('📦 Fallback: probando Google Sheets...');
                if (GOOGLE_CONFIG.ENABLED) {
                    await loadProductsFromGoogleSheets();
                } else {
                    console.log('📦 Google Sheets deshabilitado, cargando productos por defecto');
                    loadDefaultProducts();
                }
            }
        }
        
        // Cargar productos desde Google Sheets
        async function loadProductsFromGoogleSheets() {
            const results = document.getElementById('test-results');
            
            try {
                console.log('📊 Cargando productos desde Google Sheets...');
                
                if (results) {
                    results.innerHTML = '🔄 Cargando productos desde Google Sheets...';
                }
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SHEETS_ID}/values/${GOOGLE_CONFIG.STOCK_RANGE}?key=${GOOGLE_CONFIG.API_KEY}`;
                console.log('🔗 URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📊 Datos recibidos de Google Sheets:', data);
                
                if (data.values && data.values.length > 0) {
                    // Update products data
                    products = parseGoogleSheetsData(data.values);
                    console.log(`✅ ${products.length} productos cargados desde Google Sheets`);
                    
                    if (results) {
                        results.innerHTML = `✅ Inventario actualizado desde Google Sheets!<br>📊 Se cargaron ${products.length} productos`;
                    }
                    
                    // Update product selects
                    loadProductsToSelect();
                    
                    // Guardar en Firebase para próximas sesiones
                    saveProductsToFirebase();
                } else {
                    console.warn('⚠️ No hay datos en Google Sheets');
                    loadDefaultProducts();
                }
                
            } catch (error) {
                console.error('❌ Error cargando desde Google Sheets:', error);
                if (results) {
                    results.innerHTML = `❌ Error conectando con Google Sheets: ${error.message}`;
                }
                console.log('📦 Cargando productos por defecto como fallback...');
                loadDefaultProducts();
                throw error;
            }
        }
        
        // Mapear códigos de productos a nombres legibles
        function mapProductName(code) {
            const productMap = {
                'VA8011': 'Remera Básica',
                'HD4012': 'Hoodie Clásico',
                'HD4014': 'Hoodie Oversize',
                'EM2033': 'Polo Premium',
                'EM2045': 'Remera Estampada'
            };
            
            // Si encontramos el código exacto, devolver el nombre
            if (productMap[code]) {
                return productMap[code];
            }
            
            // Para códigos no reconocidos, usar el código como nombre
            // Esto permitirá ver todos los productos de la hoja
            return code || 'Producto Sin Código';
        }
        
        // Mapear códigos de colores a nombres
        function mapColorName(colorCode) {
            const colorMap = {
                'C1': 'Blanco',
                'C2': 'Negro', 
                'C3': 'Gris',
                'C4': 'Azul',
                'C5': 'Verde',
                'C6': 'Beige',
                'C7': 'Rojo',
                'C8': 'Rosa',
                'C9': 'Amarillo',
                'C10': 'Naranja'
            };
            
            return colorMap[colorCode] || colorCode;
        }
        
        // Obtener categoría basada en código de producto
        function getCategoryFromCode(code) {
            if (code.startsWith('VA') || code.startsWith('EM')) return 'Remeras';
            if (code.startsWith('HD')) return 'Buzos';
            if (code.startsWith('JE')) return 'Pantalones';
            if (code.startsWith('CA')) return 'Camperas';
            if (code.startsWith('ZA')) return 'Calzado';
            
            return 'General';
        }

        // Load products to select dropdown
        function loadProductsToSelect() {
            console.log('🔄 loadProductsToSelect() llamada');
            console.log('📊 Productos globales disponibles:', products.length);
            console.log('📋 Array de productos (primeros 5):', products.slice(0, 5)); // Show first 5 for debugging
            console.log('📋 Array de productos (estructura):', products.length > 0 ? Object.keys(products[0]) : 'array vacío');
            
            const datalists = document.querySelectorAll('[id$="productos-datalist"]');
            console.log('🎯 Datalists encontrados:', datalists.length);
            datalists.forEach((dl, i) => {
                console.log(`  - Datalist ${i+1}: ${dl.id} (${dl.children.length} opciones actuales)`);
            });
            
            // Get unique product names
            const uniqueProducts = [];
            const seenNames = new Set();
            
            console.log('🔍 Procesando productos para obtener únicos...');
            products.forEach((product, index) => {
                if (index < 5) {
                    console.log(`  Producto ${index+1}:`, product);
                }
                if (!seenNames.has(product.name)) {
                    seenNames.add(product.name);
                    uniqueProducts.push(product);
                }
            });
            
            console.log('✨ Productos únicos procesados:', uniqueProducts.length);
            console.log('📝 Nombres únicos (primeros 10):', uniqueProducts.slice(0, 10).map(p => p.name)); // Show first 10 names
            
            // Populate product datalists with unique names
            datalists.forEach((datalist, index) => {
                console.log(`🔧 Poblando datalist ${index + 1}:`, datalist.id);
                datalist.innerHTML = '';
                
                uniqueProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    datalist.appendChild(option);
                });
                
                console.log(`✅ Datalist ${index + 1} poblado con ${datalist.children.length} opciones`);
                console.log(`   Primeras 3 opciones:`, Array.from(datalist.children).slice(0, 3).map(o => o.value));
            });
            
            // Setup event listeners for existing forms
            document.querySelectorAll('.product-form').forEach(form => {
                setupProductFormEvents(form);
            });
            
            console.log('🎉 loadProductsToSelect() completado');
        }
        
        // Get colors available for a specific product
        function getColorsForProduct(productName) {
            console.log('🎨 Buscando colores para producto:', productName);
            console.log('📊 Total productos disponibles:', products.length);
            
            const colorsForProduct = [];
            const seenColors = new Set();
            
            products.forEach(product => {
                if (product.name && product.name.toLowerCase() === productName.toLowerCase() && product.color && product.color !== 'Sin color') {
                    if (!seenColors.has(product.color)) {
                        seenColors.add(product.color);
                        colorsForProduct.push(product.color);
                    }
                }
            });
            
            console.log('🎨 Colores encontrados para', productName, ':', colorsForProduct);
            
            return colorsForProduct;
        }
        
        // Update color dropdown based on selected product
        function updateColorDropdown(form, selectedProduct) {
            console.log('🔄 updateColorDropdown llamada para:', selectedProduct);
            
            const colorSelect = form.querySelector('.color-select');
            colorSelect.innerHTML = '<option value="">Seleccionar color...</option>';
            
            if (selectedProduct) {
                const availableColors = getColorsForProduct(selectedProduct);
                console.log('🎨 Colores obtenidos:', availableColors);
                
                if (availableColors.length > 0) {
                    availableColors.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color;
                        option.textContent = color;
                        colorSelect.appendChild(option);
                    });
                    
                    console.log('✅ Dropdown de colores actualizado con', availableColors.length, 'opciones');
                } else {
                    // Si no hay colores específicos, permitir entrada manual
                    const manualOption = document.createElement('option');
                    manualOption.value = 'manual';
                    manualOption.textContent = 'Escribir color...';
                    colorSelect.appendChild(manualOption);
                    
                    console.log('⚠️ No se encontraron colores para este producto, habilitando entrada manual');
                }
                
                console.log('🎨 Colores finales disponibles para', selectedProduct, ':', availableColors);
            }
        }

        // Forzar recarga de productos desde catálogo por defecto
        async function forceReloadProducts() {
            try {
                console.log('🔄 Forzando recarga de productos desde catálogo por defecto...');
                
                const confirm = window.confirm('¿Estás seguro de que quieres recargar todos los productos desde el catálogo por defecto? Esto sobrescribirá cualquier producto existente en Firebase.');
                
                if (!confirm) {
                    console.log('❌ Recarga cancelada por el usuario');
                    return;
                }
                
                // Cargar productos por defecto
                loadDefaultProducts();
                
                // Mostrar mensaje de confirmación
                const results = document.getElementById('test-results');
                if (results) {
                    results.innerHTML = `
                        <div style="background: #10b981; color: white; padding: 12px; border-radius: 6px; margin: 10px 0;">
                            ✅ <strong>Productos recargados exitosamente</strong><br>
                            📦 ${products.length} productos disponibles<br>
                            🎨 ${window.availableColors?.length || 0} colores disponibles<br>
                            💾 Guardando en Firebase...
                        </div>
                    `;
                }
                
                console.log(`✅ ${products.length} productos recargados desde catálogo por defecto`);
                alert(`✅ Productos recargados exitosamente!\n📦 ${products.length} productos disponibles\n🎨 ${window.availableColors?.length || 0} colores disponibles`);
                
            } catch (error) {
                console.error('❌ Error recargando productos:', error);
                alert('❌ Error recargando productos: ' + error.message);
            }
        }

        // Función de debug para Google Sheets
        async function debugGoogleSheetsProducts() {
            const results = document.getElementById('test-results');
            if (results) {
                results.innerHTML = '🔍 Depurando datos de Google Sheets...';
            }
            
            try {
                console.log('🔍 DEBUG: Iniciando depuración de Google Sheets');
                console.log('📊 Productos actuales en memoria:', products.length);
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SHEETS_ID}/values/${GOOGLE_CONFIG.STOCK_RANGE}?key=${GOOGLE_CONFIG.API_KEY}`;
                console.log('🔗 URL completa:', url);
                
                const response = await fetch(url);
                console.log('📡 Status de respuesta:', response.status);
                
                const data = await response.json();
                console.log('📊 Datos completos recibidos:', data);
                
                if (data.values) {
                    console.log(`📋 Total de filas: ${data.values.length}`);
                    console.log('📋 Primeras 5 filas:', data.values.slice(0, 5));
                    console.log('📋 Headers (fila 1):', data.values[0]);
                    
                    // Contar productos válidos
                    let validProducts = 0;
                    for (let i = 1; i < data.values.length; i++) {
                        const row = data.values[i];
                        if (row.length >= 3 && row[0]) { // Tiene código y al menos 3 columnas
                            validProducts++;
                        }
                    }
                    
                    console.log(`📦 Productos válidos encontrados: ${validProducts}`);
                    
                    // Forzar actualización de productos desde estos datos
                    products = parseGoogleSheetsData(data.values);
                    console.log(`✅ Productos actualizados: ${products.length}`);
                    
                    // Forzar actualización de los selectores
                    loadProductsToSelect();
                    
                    const message = `
                        <div style="background: #10b981; color: white; padding: 12px; border-radius: 6px;">
                            ✅ <strong>Depuración y carga exitosa</strong><br>
                            📊 Total de filas en hoja: ${data.values.length}<br>
                            📦 Productos válidos encontrados: ${validProducts}<br>
                            🔄 Productos cargados en memoria: ${products.length}<br>
                            📋 Rango usado: ${GOOGLE_CONFIG.STOCK_RANGE}<br>
                            🎨 Revisa la consola (F12) para más detalles
                        </div>
                    `;
                    
                    if (results) results.innerHTML = message;
                    
                } else {
                    throw new Error('No se recibieron datos de la hoja');
                }
                
            } catch (error) {
                console.error('❌ Error en debug:', error);
                const message = `
                    <div style="background: #dc2626; color: white; padding: 12px; border-radius: 6px;">
                        ❌ <strong>Error en depuración</strong><br>
                        📝 ${error.message}<br>
                        💡 Verifica que la hoja sea pública y el rango sea correcto
                    </div>
                `;
                if (results) results.innerHTML = message;
            }
        }

        // Función para forzar carga completa desde Google Sheets
        async function forceLoadFromGoogleSheets() {
            const results = document.getElementById('test-results');
            if (results) {
                results.innerHTML = '🔄 Forzando carga completa desde Google Sheets...';
            }
            
            try {
                console.log('🔄 FORZANDO carga completa de productos desde Google Sheets...');
                console.log('📊 Productos antes de la carga:', products.length);
                
                // Limpiar productos actuales
                products = [];
                window.products = [];
                
                // Cargar productos desde Google Sheets
                await loadProductsFromGoogleSheets();
                
                // Ensure global synchronization
                window.products = products;
                
                console.log('📊 Productos después de la carga:', products.length);
                console.log('🌍 Productos en window.products:', window.products.length);
                
                // Force update of all product selectors and event listeners
                setTimeout(() => {
                    console.log('🔄 Forzando actualización de selectores de productos...');
                    loadProductsToSelect();
                    
                    // Re-setup event listeners for any existing forms
                    document.querySelectorAll('.product-form').forEach(form => {
                        console.log('🔧 Re-configurando event listeners para formulario');
                        setupProductFormEvents(form);
                    });
                }, 100);
                
                // Verificar que los productos se hayan cargado
                if (products.length > 0) {
                    const message = `
                        <div style="background: #10b981; color: white; padding: 12px; border-radius: 6px;">
                            ✅ <strong>Carga completa exitosa</strong><br>
                            📦 ${products.length} productos cargados desde Google Sheets<br>
                            🎨 ${window.availableColors?.length || 0} colores disponibles<br>
                            🔄 Selectores de productos actualizados
                        </div>
                    `;
                    if (results) results.innerHTML = message;
                } else {
                    throw new Error('No se cargaron productos desde Google Sheets');
                }
                
            } catch (error) {
                console.error('❌ Error en carga forzada:', error);
                const message = `
                    <div style="background: #dc2626; color: white; padding: 12px; border-radius: 6px;">
                        ❌ <strong>Error en carga forzada</strong><br>
                        📝 ${error.message}<br>
                        💡 Cargando productos por defecto como respaldo...
                    </div>
                `;
                if (results) results.innerHTML = message;
                
                // Cargar productos por defecto como respaldo
                loadDefaultProducts();
            }
        }

        // Test storage
        function testStorage() {
            const results = document.getElementById('test-results');
            try {
                localStorage.setItem('test_key', 'test_value');
                const value = localStorage.getItem('test_key');
                localStorage.removeItem('test_key');
                
                if (value === 'test_value') {
                    results.innerHTML = '✅ LocalStorage funciona correctamente';
                } else {
                    results.innerHTML = '❌ LocalStorage no funciona correctamente';
                }
            } catch (error) {
                results.innerHTML = '❌ Error en LocalStorage: ' + error.message;
            }
        }

        // Add product
        function addProduct() {
            const container = document.getElementById('productos-container');
            const productCount = container.children.length;
            
            // Create new product form
            const newProductForm = document.createElement('div');
            newProductForm.className = 'product-form';
            newProductForm.innerHTML = `
                <div style="position: relative;">
                    <input type="text" class="form-control producto-input" placeholder="Escribir o seleccionar producto..." list="productos-datalist-${productCount}" data-index="${productCount}">
                    <datalist id="productos-datalist-${productCount}">
                    </datalist>
                </div>
                <select class="form-control color-select">
                    <option value="">Seleccionar color...</option>
                </select>
                <input type="number" class="form-control cantidad-input" value="1" min="1" data-index="${productCount}">
                <input type="text" class="form-control precio-input" placeholder="$0">
                <select class="form-control iva-select">
                    <option value="0">0%</option>
                    <option value="10.5">10.5%</option>
                    <option value="21">21%</option>
                </select>
                <input type="text" class="form-control subtotal-input" readonly placeholder="$0">
                <button type="button" class="btn-delete" onclick="removeProduct(this)">Eliminar</button>
            `;
            
            container.appendChild(newProductForm);
            
            // Get unique product names
            const uniqueProducts = [];
            const seenNames = new Set();
            
            products.forEach(product => {
                if (!seenNames.has(product.name)) {
                    seenNames.add(product.name);
                    uniqueProducts.push(product);
                }
            });
            
            // Populate the new datalist with unique product names
            const newDatalist = newProductForm.querySelector(`#productos-datalist-${productCount}`);
            uniqueProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                newDatalist.appendChild(option);
            });
            
            // Add event listeners to new elements
            setupProductFormEvents(newProductForm);
        }
        
        // Remove product
        function removeProduct(button) {
            const productForm = button.closest('.product-form');
            if (document.querySelectorAll('.product-form').length > 1) {
                productForm.remove();
                updateTotalFromAllProducts();
            } else {
                alert('Debe haber al menos un producto en el pedido');
            }
        }
        
        // Setup event listeners for a product form
        function setupProductFormEvents(form) {
            console.log('🔧 Configurando event listeners para formulario de producto');
            
            const input = form.querySelector('.producto-input');
            const colorSelect = form.querySelector('.color-select');
            const cantidadInput = form.querySelector('.cantidad-input');
            const precioInput = form.querySelector('.precio-input');
            const ivaSelect = form.querySelector('.iva-select');
            
            // Remove existing listeners to avoid duplicates
            const newInput = input.cloneNode(true);
            const newColorSelect = colorSelect.cloneNode(true);
            const newCantidadInput = cantidadInput.cloneNode(true);
            const newPrecioInput = precioInput.cloneNode(true);
            const newIvaSelect = ivaSelect.cloneNode(true);
            
            input.parentNode.replaceChild(newInput, input);
            colorSelect.parentNode.replaceChild(newColorSelect, colorSelect);
            cantidadInput.parentNode.replaceChild(newCantidadInput, cantidadInput);
            precioInput.parentNode.replaceChild(newPrecioInput, precioInput);
            ivaSelect.parentNode.replaceChild(newIvaSelect, ivaSelect);
            
            // Product input change
            newInput.addEventListener('input', function() {
                const selectedProduct = this.value.trim();
                console.log('🎯 Producto seleccionado:', selectedProduct);
                
                // Auto-check products if list seems empty
                if (products.length < 10 && selectedProduct.length > 2) {
                    console.log('🔍 AUTO-CHECK: Product list seems incomplete, checking for updates...');
                    autoCheckProducts();
                }
                
                // Clear color and price when product changes
                newColorSelect.value = '';
                form.querySelector('.subtotal-input').value = '$0';
                
                // Check if this is a known product from our database
                const knownProduct = products.find(p => p.name.toLowerCase() === selectedProduct.toLowerCase());
                console.log('🔍 Producto conocido encontrado:', !!knownProduct);
                
                if (knownProduct) {
                    // Known product - make price readonly and update color dropdown
                    newPrecioInput.readOnly = true;
                    newPrecioInput.style.backgroundColor = '#f9fafb';
                    console.log('🎨 Actualizando dropdown de colores para:', selectedProduct);
                    updateColorDropdown(form, selectedProduct);
                    updatePriceForSelection(form);
                } else {
                    // Manual product - make price editable and clear colors
                    newPrecioInput.readOnly = false;
                    newPrecioInput.style.backgroundColor = 'white';
                    newPrecioInput.value = '';
                    newColorSelect.innerHTML = '<option value="">Escribir color manualmente</option>';
                    
                    // Add a manual color input option
                    const manualColorOption = document.createElement('option');
                    manualColorOption.value = 'manual';
                    manualColorOption.textContent = 'Escribir color...';
                    newColorSelect.appendChild(manualColorOption);
                }
            });
            
            // Color selection change
            newColorSelect.addEventListener('change', function() {
                console.log('🎨 Color seleccionado:', this.value);
                if (this.value === 'manual') {
                    const manualColor = prompt('Escriba el color del producto:');
                    if (manualColor) {
                        // Add the manual color as an option and select it
                        const option = document.createElement('option');
                        option.value = manualColor;
                        option.textContent = manualColor;
                        this.appendChild(option);
                        this.value = manualColor;
                    }
                }
                updatePriceForSelection(form);
            });
            
            // Quantity change
            newCantidadInput.addEventListener('input', function() {
                updateSubtotalForForm(form);
            });
            
            // IVA change
            newIvaSelect.addEventListener('change', function() {
                updateSubtotalForForm(form);
            });
            
            // Price input change (for manual products)
            newPrecioInput.addEventListener('input', function() {
                if (!newPrecioInput.readOnly) {
                    // Format the price as user types
                    let value = this.value.replace(/[^\d]/g, '');
                    if (value) {
                        this.value = '$' + parseInt(value).toLocaleString('es-AR');
                    }
                    updateSubtotalForForm(form);
                }
            });
            
            console.log('✅ Event listeners configurados para formulario de producto');
        }
        
        // Update price when product or color selection changes
        function updatePriceForSelection(form) {
            const input = form.querySelector('.producto-input');
            const colorSelect = form.querySelector('.color-select');
            const precioInput = form.querySelector('.precio-input');
            
            const selectedProduct = input.value.trim();
            const selectedColor = colorSelect.value;
            
            // Only auto-update price if this is a known product and price field is readonly
            if (precioInput.readOnly && selectedProduct && selectedColor && selectedColor !== 'manual') {
                // Find the exact product with this name and color combination
                const exactProduct = products.find(p => 
                    p.name.toLowerCase() === selectedProduct.toLowerCase() && 
                    p.color.toLowerCase() === selectedColor.toLowerCase()
                );
                
                if (exactProduct) {
                    const price = exactProduct.price;
                    precioInput.value = '$' + price.toLocaleString('es-AR', { 
                        minimumFractionDigits: 0, 
                        maximumFractionDigits: 0 
                    });
                    
                    console.log('Precio encontrado para', selectedProduct, selectedColor, ':', price);
                    updateSubtotalForForm(form);
                } else {
                    precioInput.value = '$0';
                    form.querySelector('.subtotal-input').value = '$0';
                    updateTotalFromAllProducts();
                }
            } else if (precioInput.readOnly && selectedProduct && !selectedColor) {
                // If only product is selected, show base price or first available price
                const baseProduct = products.find(p => p.name.toLowerCase() === selectedProduct.toLowerCase());
                if (baseProduct) {
                    const price = baseProduct.price;
                    precioInput.value = '$' + price.toLocaleString('es-AR', { 
                        minimumFractionDigits: 0, 
                        maximumFractionDigits: 0 
                    });
                    updateSubtotalForForm(form);
                }
            } else if (!precioInput.readOnly) {
                // For manual products, don't auto-update price, let user set it
                updateSubtotalForForm(form);
            } else {
                precioInput.value = '$0';
                form.querySelector('.subtotal-input').value = '$0';
                updateTotalFromAllProducts();
            }
        }
        
        // Update subtotal for a specific form
        function updateSubtotalForForm(form) {
            const input = form.querySelector('.producto-input');
            const colorSelect = form.querySelector('.color-select');
            const cantidadInput = form.querySelector('.cantidad-input');
            const subtotalInput = form.querySelector('.subtotal-input');
            const precioInput = form.querySelector('.precio-input');
            const ivaSelect = form.querySelector('.iva-select');
            
            if (input.value.trim() && cantidadInput.value) {
                // Extract price from the price input field
                const priceText = precioInput.value.replace('$', '').replace(/\./g, '').replace(/,/g, '');
                const basePrice = parseFloat(priceText) || 0;
                const quantity = parseInt(cantidadInput.value || 0);
                const ivaPercentage = parseFloat(ivaSelect.value || 0);
                
                // Calculate price with IVA
                const priceWithIva = basePrice * (1 + ivaPercentage / 100);
                const subtotal = priceWithIva * quantity;
                
                subtotalInput.value = '$' + subtotal.toLocaleString('es-AR', { 
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                });
                
                updateTotalFromAllProducts();
            } else {
                subtotalInput.value = '$0';
                updateTotalFromAllProducts();
            }
        }
        
        // Update total from all products
        function updateTotalFromAllProducts() {
            const allSubtotals = document.querySelectorAll('.subtotal-input');
            let total = 0;
            
            allSubtotals.forEach(subtotalInput => {
                const subtotalText = subtotalInput.value.replace('$', '').replace(/\./g, '').replace(/,/g, '');
                const subtotal = parseFloat(subtotalText) || 0;
                total += subtotal;
            });
            
            // Update base total
            document.getElementById('total-amount').textContent = total.toLocaleString('es-AR', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            });
            
            // Calculate discount and final total
            updateFinalTotal();
        }
        
        // Update final total with discount
        function updateFinalTotal() {
            const totalText = document.getElementById('total-amount').textContent.replace(/\./g, '').replace(/,/g, '');
            const total = parseFloat(totalText) || 0;
            const discountPercentage = parseFloat(document.getElementById('discount-input').value || 0);
            const commissionPercentage = parseFloat(document.getElementById('commission-input').value || 0);
            
            const discountAmount = total * (discountPercentage / 100);
            const finalTotal = total - discountAmount;
            const commissionAmount = finalTotal * (commissionPercentage / 100);
            
            document.getElementById('discount-amount').textContent = discountAmount.toLocaleString('es-AR', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            });
            
            document.getElementById('commission-amount').textContent = commissionAmount.toLocaleString('es-AR', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            });
            
            document.getElementById('final-total').textContent = finalTotal.toLocaleString('es-AR', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            });
        }

        // Add discount input event listener
        document.addEventListener('DOMContentLoaded', function() {
            const discountInput = document.getElementById('discount-input');
            const commissionInput = document.getElementById('commission-input');
            
            discountInput.addEventListener('input', function() {
                updateFinalTotal();
            });
            
            commissionInput.addEventListener('input', function() {
                updateFinalTotal();
            });
        });

        // Test Firebase function (safe version)
        window.testFirebaseAfterSetup = async function() {
            const results = document.getElementById('test-results');
            if (!results) {
                alert('❌ Error: No se encontró el elemento de resultados');
                return;
            }
            
            try {
                results.innerHTML = '🔄 Probando Firebase...';
                console.log('🧪 Iniciando test de Firebase...');
                
                // Check if firebaseService exists
                if (!window.firebaseService) {
                    throw new Error('FirebaseService no está disponible. Verifica que los scripts estén cargados.');
                }
                
                // Check if Firebase is initialized
                if (!window.firebaseService.isInitialized) {
                    throw new Error('Firebase no está inicializado. Revisa las reglas de Firestore en Firebase Console.');
                }
                
                // Create a test order
                const testOrder = {
                    numero: 'TEST-' + Date.now(),
                    fecha: new Date().toISOString(),
                    cliente: {
                        nombre: 'Cliente de Prueba',
                        telefono: '123456789',
                        email: 'test@test.com',
                        direccion: 'Dirección de prueba'
                    },
                    productos: [{
                        product: 'Producto de prueba',
                        color: 'Rojo',
                        quantity: 1,
                        price: '100',
                        iva: 0,
                        subtotal: '100'
                    }],
                    subtotal: 100,
                    descuento: 0,
                    comision: 0,
                    total: 100,
                    estado: 'pendiente'
                };
                
                results.innerHTML = '💾 Guardando pedido de prueba en Firebase...';
                console.log('💾 Guardando pedido de prueba...');
                
                const result = await window.firebaseService.savePedido(testOrder);
                
                if (result.success) {
                    console.log('✅ Test exitoso - Pedido guardado:', result.id);
                    
                    // Load orders to verify
                    results.innerHTML = '📥 Verificando carga de pedidos...';
                    const pedidos = await window.firebaseService.loadPedidos();
                    
                    results.innerHTML = `✅ ¡Firebase funciona perfectamente!<br>
                                       🔥 Conexión exitosa<br>
                                       💾 Pedido de prueba guardado (ID: ${result.id})<br>
                                       📥 ${pedidos.length} pedidos cargados<br>
                                       📱 La app funcionará en cualquier computadora`;
                    
                    alert('✅ ¡Firebase configurado correctamente!\n\n' +
                          '🔥 Conexión exitosa\n' +
                          '💾 Pedido de prueba guardado\n' +
                          '📱 La app funcionará en cualquier computadora');
                    
                } else {
                    throw new Error(result.error || 'Error desconocido guardando pedido');
                }
                
            } catch (error) {
                console.error('❌ Error en test de Firebase:', error);
                
                let errorMessage = '❌ Error en Firebase:<br>';
                
                if (error.message.includes('Missing or insufficient permissions')) {
                    errorMessage += '🚨 <strong>Problema de permisos</strong><br>';
                    errorMessage += '📋 Necesitas configurar las reglas de Firestore<br>';
                    errorMessage += '🔗 Ve a Firebase Console → Firestore → Reglas<br>';
                    errorMessage += '📝 Haz clic en "📋 Ver Reglas de Firestore" para obtener las reglas correctas';
                } else if (error.message.includes('unavailable')) {
                    errorMessage += '🌐 <strong>Problema de conexión</strong><br>';
                    errorMessage += '📶 Verifica tu conexión a internet<br>';
                    errorMessage += '🔄 Intenta nuevamente en unos momentos';
                } else {
                    errorMessage += error.message;
                }
                
                results.innerHTML = errorMessage;
                alert('❌ Error en Firebase:\n' + error.message + '\n\nRevisa las reglas de Firestore');
            }
        };

        // Create order - FIREBASE VERSION
        async function createOrder() {
            console.log('🚀 CREACIÓN DE PEDIDO CON FIREBASE...');
            
            try {
                // Step 1: Quick validation
                const nombre = document.getElementById('cliente-nombre').value;
                const telefono = document.getElementById('cliente-telefono').value;
                const email = document.getElementById('cliente-email').value;
                const direccion = document.getElementById('cliente-direccion').value;
                const fechaPedido = document.getElementById('fecha-pedido').value;
                const productForms = document.querySelectorAll('.product-form');
                
                if (!nombre || !telefono) {
                    alert('Por favor completa los datos del cliente (Nombre y Teléfono son obligatorios)');
                    return;
                }
                
                // Step 2: Quick product validation and collection
                let hasProducts = false;
                const orderProducts = [];
                
                productForms.forEach(form => {
                    const input = form.querySelector('.producto-input');
                    const colorSelect = form.querySelector('.color-select');
                    const cantidad = form.querySelector('.cantidad-input').value;
                    const precio = form.querySelector('.precio-input').value;
                    const iva = form.querySelector('.iva-select').value;
                    const subtotal = form.querySelector('.subtotal-input').value;
                    
                    if (input.value.trim()) {
                        hasProducts = true;
                        orderProducts.push({
                            product: input.value.trim(),
                            color: colorSelect.value || 'Sin color',
                            quantity: parseInt(cantidad),
                            price: precio,
                            iva: parseFloat(iva),
                            subtotal: subtotal
                        });
                    }
                });
                
                if (!hasProducts) {
                    alert('Por favor selecciona al menos un producto');
                    return;
                }
                
                // Step 3: Create order object IMMEDIATELY
                const orderDate = fechaPedido ? new Date(fechaPedido).toLocaleString('es-AR') : new Date().toLocaleString('es-AR');
                const totalAmount = document.getElementById('total-amount').textContent;
                const discountPercentage = parseFloat(document.getElementById('discount-input').value || 0);
                const commissionPercentage = parseFloat(document.getElementById('commission-input').value || 0);
                const finalTotal = document.getElementById('final-total').textContent;
                const discountAmount = document.getElementById('discount-amount').textContent;
                const commissionAmount = document.getElementById('commission-amount').textContent;
                
                // Parse currency values correctly
                const parsedSubtotal = parseCurrency(totalAmount);
                const parsedTotal = parseCurrency(finalTotal);
                const parsedDiscountAmount = parseCurrency(discountAmount);
                const parsedCommissionAmount = parseCurrency(commissionAmount);
                
                console.log('💰 Valores parseados:');
                console.log('- Subtotal:', totalAmount, '->', parsedSubtotal);
                console.log('- Total:', finalTotal, '->', parsedTotal);
                console.log('- Descuento:', discountAmount, '->', parsedDiscountAmount);
                console.log('- Comisión:', commissionAmount, '->', parsedCommissionAmount);
                
                const order = {
                    id: editingOrderId ? editingOrderId.toString() : generateOrderNumber(),
                    date: new Date().toISOString(),
                    customer: {
                        name: nombre,
                        phone: telefono,
                        email: email,
                        address: direccion
                    },
                    products: orderProducts,
                    subtotal: parsedSubtotal,
                    discount: {
                        percentage: discountPercentage,
                        amount: parsedDiscountAmount
                    },
                    commission: {
                        percentage: commissionPercentage,
                        amount: parsedCommissionAmount
                    },
                    total: parsedTotal,
                    fechaPedido: fechaPedido || new Date().toISOString(),
                    status: 'Pendiente'
                };
                
                console.log('🆔 ORDER ID CREATED:', order.id, '(type:', typeof order.id, ')');
                console.log('📦 Complete order object:', order);
                
                // Step 4: IMMEDIATE Firebase save
                console.log('💾 Guardando en Firebase...');
                const result = await window.firebaseService.savePedido(order);
                
                if (result.success) {
                    console.log('✅ Pedido guardado en Firebase:', result.id);
                    
                    // Update local orders array
                    if (editingOrderId) {
                        const orderIndex = orders.findIndex(o => o.id === editingOrderId);
                        if (orderIndex !== -1) {
                            orders[orderIndex] = { ...order, id: result.id || editingOrderId };
                        }
                        editingOrderId = null;
                        resetFormToCreateMode();
                    } else {
                        orders.push({ ...order, id: result.id || order.id });
                    }
                    
                    // Update localStorage as backup
                    localStorage.setItem('pedidos', JSON.stringify(orders));
                    
                    // IMMEDIATE UI feedback
                    alert('✅ ¡Pedido creado exitosamente!\n\n🔥 Guardado en Firebase\n📱 Disponible en todas las computadoras');
                    
                    // Clear form and switch tab
                    clearOrderForm();
                    setTimeout(() => {
                        try {
                            switchTab('pedidos-lista');
                            loadOrdersFromFirebase();
                        } catch (error) {
                            console.error('❌ Error cambiando de pestaña:', error);
                            loadOrdersFromFirebase();
                        }
                    }, 100);
                    
                } else {
                    console.error('❌ Error guardando en Firebase:', result.error);
                    
                    // Fallback to localStorage
                    orders.push(order);
                    localStorage.setItem('pedidos', JSON.stringify(orders));
                    
                    alert('⚠️ Pedido guardado localmente\n❌ Error conectando con Firebase\nSe sincronizará cuando haya conexión');
                    
                    clearOrderForm();
                    setTimeout(() => {
                        try {
                            switchTab('pedidos-lista');
                            displayOrdersList();
                        } catch (error) {
                            console.error('❌ Error cambiando de pestaña:', error);
                            displayOrdersList();
                        }
                    }, 100);
                }
                
                console.log('✅ Pedido procesado correctamente');
                
            } catch (globalError) {
                console.error('🚨 ERROR EN createOrder:', globalError);
                alert(`🚨 Error creando el pedido: ${globalError.message}`);
            }
        }
        
        // Background sync - NO BLOCKING
        async function syncToGoogleSheetsBackground(order, orderProducts) {
            if (!GOOGLE_CONFIG.ENABLED || !GOOGLE_CONFIG.WRITE_ENABLED) {
                console.log('📱 Pedido guardado localmente (Google Sheets escritura deshabilitada)');
                showNotification('📱 Pedido guardado localmente', 'info');
                return;
            }

            try {
                console.log('🔄 Iniciando sincronización en segundo plano...');
                
                // Start both operations in parallel
                const writePromise = writeOrderToGoogleSheets(order);
                const stockPromise = updateStockBackground(orderProducts);
                
                // Wait for both to complete
                const [writeResult, stockResult] = await Promise.all([writePromise, stockPromise]);
                
                // Reset error count on success
                GOOGLE_CONFIG.ERROR_COUNT = 0;
                
                // Update UI with sync status
                updateSyncStatus(writeResult, stockResult);
                
                // Process any queued operations
                processQueue();
                
            } catch (error) {
                console.error('❌ Error en sincronización background:', error);
                handleSyncError(error);
            }
        }

        // Handle sync errors with auto-disable
        function handleSyncError(error) {
            GOOGLE_CONFIG.ERROR_COUNT++;
            
            if (GOOGLE_CONFIG.ERROR_COUNT >= GOOGLE_CONFIG.MAX_ERRORS) {
                GOOGLE_CONFIG.ENABLED = false;
                console.warn('🚨 Google Sheets deshabilitado automáticamente por múltiples errores');
                showNotification('🚨 Google Sheets deshabilitado por errores. Los pedidos se guardan solo localmente.', 'warning');
            } else {
                showNotification(`⚠️ Error de sincronización (${GOOGLE_CONFIG.ERROR_COUNT}/${GOOGLE_CONFIG.MAX_ERRORS})`, 'error');
            }
        }

        // Show notifications to user
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.getElementById('sync-notification');
            if (existing) existing.remove();
            
            // Create notification
            const notification = document.createElement('div');
            notification.id = 'sync-notification';
            notification.innerHTML = message;
            
            // Style based on type
            const baseStyle = 'position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; z-index: 1000; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease;';
            
            if (type === 'error') {
                notification.style.cssText = baseStyle + 'background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;';
            } else if (type === 'warning') {
                notification.style.cssText = baseStyle + 'background: #fef3c7; color: #d97706; border: 1px solid #fde68a;';
            } else if (type === 'success') {
                notification.style.cssText = baseStyle + 'background: #d1fae5; color: #059669; border: 1px solid #a7f3d0;';
            } else {
                notification.style.cssText = baseStyle + 'background: #dbeafe; color: #2563eb; border: 1px solid #bfdbfe;';
            }
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        // Update sync status in UI
        function updateSyncStatus(writeResult, stockResult) {
            const successMessage = [];
            const errorMessage = [];
            
            if (writeResult.success) {
                successMessage.push('📝 Pedido guardado en Google Sheets');
            } else {
                errorMessage.push('❌ Error guardando pedido');
            }
            
            if (stockResult.success) {
                successMessage.push(`📦 Stock actualizado (${stockResult.updated} productos)`);
            } else {
                errorMessage.push('❌ Error actualizando stock');
            }
            
            // Show subtle notification
            showSyncNotification(successMessage, errorMessage);
        }
        
        // Show sync notification
        function showSyncNotification(success, errors) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${errors.length > 0 ? '#fef2f2' : '#f0fdf4'};
                border: 2px solid ${errors.length > 0 ? '#dc2626' : '#059669'};
                border-radius: 8px;
                padding: 12px 16px;
                max-width: 300px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-size: 14px;
            `;
            
            let content = '';
            if (success.length > 0) {
                content += success.map(msg => `<div style="color: #059669; margin-bottom: 4px;">${msg}</div>`).join('');
            }
            if (errors.length > 0) {
                content += errors.map(msg => `<div style="color: #dc2626; margin-bottom: 4px;">${msg}</div>`).join('');
            }
            
            notification.innerHTML = content;
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        // Show sync error
        function showSyncError(error) {
            console.error('❌ Error de sincronización:', error);
            showSyncNotification([], [`❌ Error de sincronización: ${error.message}`]);
        }
        
        // Cancel edit mode
        function cancelEdit() {
            if (confirm('¿Estás seguro de que quieres cancelar la edición? Los cambios no guardados se perderán.')) {
                editingOrderId = null;
                resetFormToCreateMode();
                clearOrderForm();
            }
        }
        
        // Reset form UI to create mode
        function resetFormToCreateMode() {
            const submitBtn = document.getElementById('submit-order-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');
            
            submitBtn.textContent = 'Crear Pedido';
            submitBtn.className = 'btn success';
            cancelBtn.style.display = 'none';
        }
        
        // Set form UI to edit mode
        function setFormToEditMode() {
            const submitBtn = document.getElementById('submit-order-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');
            
            submitBtn.textContent = 'Guardar Pedido';
            submitBtn.className = 'btn success';
            cancelBtn.style.display = 'block';
        }
        
        // Clear order form
        function clearOrderForm() {
            document.getElementById('cliente-nombre').value = '';
            document.getElementById('cliente-telefono').value = '';
            document.getElementById('cliente-email').value = '';
            document.getElementById('cliente-direccion').value = '';
            document.getElementById('fecha-pedido').value = '';
            
            // Reset products container to single empty product
            const container = document.getElementById('productos-container');
            container.innerHTML = `
                <div class="product-form">
                    <div style="position: relative;">
                        <input type="text" id="producto-input" class="form-control producto-input" placeholder="Escribir o seleccionar producto..." list="productos-datalist" data-index="0">
                        <datalist id="productos-datalist">
                        </datalist>
                    </div>
                    <select id="color-select" class="form-control color-select">
                        <option value="">Seleccionar color...</option>
                    </select>
                    <input type="number" id="cantidad-input" class="form-control cantidad-input" value="1" min="1" data-index="0">
                    <input type="text" id="precio-input" class="form-control precio-input" placeholder="$0">
                    <select id="iva-select" class="form-control iva-select">
                        <option value="0">0%</option>
                        <option value="10.5">10.5%</option>
                        <option value="21">21%</option>
                    </select>
                    <input type="text" id="subtotal-input" class="form-control subtotal-input" readonly placeholder="$0">
                    <button type="button" class="btn-delete" onclick="removeProduct(this)">Eliminar</button>
                </div>
            `;
            
            document.getElementById('total-amount').textContent = '0';
            document.getElementById('discount-input').value = '0';
            document.getElementById('discount-amount').textContent = '0';
            document.getElementById('commission-input').value = '0';
            document.getElementById('commission-amount').textContent = '0';
            document.getElementById('final-total').textContent = '0';
            
            // Reset editing state
            editingOrderId = null;
            resetFormToCreateMode();
            
            // Reload products to selects
            loadProductsToSelect();
        }
        
        // Display orders list
        function displayOrdersList() {
            console.log('🔍 DEBUG displayOrdersList - START');
            console.log('- orders variable:', orders);
            console.log('- orders length:', orders.length);
            
            const container = document.getElementById('orders-container');
            console.log('- container found:', !!container);
            
            // Debug each order
            orders.forEach((order, index) => {
                console.log(`- Order ${index}:`, {
                    id: order.id,
                    status: order.status,
                    statusLength: order.status?.length,
                    statusBytes: order.status ? Array.from(order.status).map(c => c.charCodeAt(0)) : null,
                    customer: order.customer?.name,
                    total: order.total
                });
                
                // Check exact comparison
                console.log(`  - order.status !== 'Liquidado': ${order.status !== 'Liquidado'}`);
                console.log(`  - status === 'Pendiente': ${order.status === 'Pendiente'}`);
            });
            
            const pendingOrders = orders.filter(order => order.status !== 'Liquidado');
            console.log('- pendingOrders:', pendingOrders);
            console.log('- pendingOrders length:', pendingOrders.length);
            
            if (pendingOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">No hay pedidos pendientes</p>';
                console.log('- No pending orders found, showing message');
                return;
            }
            
            // Sort orders by date (oldest first)
            pendingOrders.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = '';
            
            pendingOrders.forEach(order => {
                // Safe access to customer and products
                const customer = order.customer || {};
                const productsArr = Array.isArray(order.products) ? order.products : [];
                // Format date
                let orderDate = '';
                try {
                    orderDate = new Date(order.date).toLocaleDateString('es-AR', {
                        day: '2-digit',
                        month: '2-digit'
                    });
                } catch (e) {
                    orderDate = 'Sin fecha';
                }
                html += `
                    <div class="compact-order-item" onclick="toggleOrderDetails(${order.id}, 'pending')">
                        <div class="compact-order-main">
                            <div class="compact-order-id">#${order.id || ''}</div>
                            <div class="compact-order-customer">${customer.name || 'Sin nombre'}</div>
                            <div class="compact-order-total">$${formatCurrency(order.total || 0)}</div>
                            <div class="order-status status-pendiente">${order.status || 'Pendiente'}</div>
                        </div>
                        <div class="compact-order-date">${orderDate}</div>
                    </div>
                    <div id="pending-details-${order.id}" class="order-details-expanded" style="display: none;">
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-id">#${order.id || ''}</div>
                                <div class="order-status status-pendiente">${order.status || 'Pendiente'}</div>
                            </div>
                            <div class="order-info">
                                <div class="info-item">
                                    <div class="info-label">Cliente</div>
                                    <div class="info-value">${customer.name || 'Sin nombre'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Teléfono</div>
                                    <div class="info-value">${customer.phone || 'Sin teléfono'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Fecha</div>
                                    <div class="info-value">${orderDate}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">${customer.email || 'No especificado'}</div>
                                </div>
                            </div>
                            ${customer.address ? `
                                <div class="info-item" style="margin-bottom: 16px;">
                                    <div class="info-label">Dirección</div>
                                    <div class="info-value">${customer.address}</div>
                                </div>
                            ` : ''}
                            <div class="order-products">
                                <div class="products-title">Productos</div>
                                ${productsArr.map((product, index) => `
                                    <div class="product-item">
                                        ${index + 1}. ${product.product || 'Sin producto'} (${product.color || 'Sin color'}) x${product.quantity || 0} - IVA: ${product.iva || 0}% = $${formatCurrency(product.subtotal)}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="order-total">Subtotal: $${formatCurrency(order.subtotal || order.total || 0)}</div>
                            ${order.discount && order.discount.percentage > 0 ? `
                                <div style="text-align: center; color: #ef4444; margin: 8px 0;">
                                    Descuento ${order.discount.percentage}%: -$${formatCurrency(order.discount.amount || 0)}
                                </div>
                            ` : ''}
                            ${order.commission && order.commission.percentage > 0 ? `
                                <div style="text-align: center; color: #3b82f6; margin: 8px 0;">
                                    Comisión Vendedor ${order.commission.percentage}%: +$${formatCurrency(order.commission.amount || 0)}
                                </div>
                            ` : ''}
                            <div class="order-total">Total Final: $${formatCurrency(order.total || 0)}</div>
                            <div class="order-actions">
                                <button class="btn secondary btn-small" onclick="editOrder('${order.id}')">Editar</button>
                                <button class="btn success btn-small" onclick="liquidateOrder('${order.id}')">Liquidar</button>
                                <button class="btn danger btn-small" onclick="deleteOrder('${order.id}')">Eliminar</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Toggle order details visibility
        function toggleOrderDetails(orderId, type) {
            console.log('🔄 toggleOrderDetails called:', orderId, type);
            
            // Build the correct ID based on type
            let detailsId;
            if (type === 'pending') {
                detailsId = `pending-details-${orderId}`;
            } else if (type === 'liquidated') {
                detailsId = `liquidated-details-${orderId}`;
            } else {
                // Fallback for old calls
                detailsId = `details-${orderId}`;
            }
            
            console.log('- Looking for element with ID:', detailsId);
            const detailsElement = document.getElementById(detailsId);
            console.log('- Details element found:', !!detailsElement);
            
            if (detailsElement) {
                if (detailsElement.style.display === 'none' || detailsElement.style.display === '') {
                    // Hide all other details first within the same container
                    document.querySelectorAll('.order-details-expanded').forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Show this details
                    detailsElement.style.display = 'block';
                    detailsElement.style.animation = 'slideDown 0.3s ease';
                    console.log('- Details shown for:', detailsId);
                } else {
                    // Hide this details
                    detailsElement.style.display = 'none';
                    console.log('- Details hidden for:', detailsId);
                }
            } else {
                console.error('❌ No se encontró elemento de detalles:', detailsId);
            }
        }
        
        // Edit order
        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            if (order.status === 'Liquidado') {
                alert('No se pueden editar pedidos que ya han sido liquidados.');
                return;
            }
            
            editingOrderId = orderId;
            
            // Set form to edit mode
            setFormToEditMode();
            
            // Fill customer data
            document.getElementById('cliente-nombre').value = order.customer.name;
            document.getElementById('cliente-telefono').value = order.customer.phone;
            document.getElementById('cliente-email').value = order.customer.email || '';
            document.getElementById('cliente-direccion').value = order.customer.address || '';
            document.getElementById('fecha-pedido').value = order.fechaPedido || '';
            
            // Clear products container
            const container = document.getElementById('productos-container');
            container.innerHTML = '';
            
            // Add products from order
            order.products.forEach((product, index) => {
                const productForm = document.createElement('div');
                productForm.className = 'product-form';
                productForm.innerHTML = `
                    <div style="position: relative;">
                        <input type="text" class="form-control producto-input" placeholder="Escribir o seleccionar producto..." list="productos-datalist-edit-${index}" data-index="${index}">
                        <datalist id="productos-datalist-edit-${index}">
                        </datalist>
                    </div>
                    <select class="form-control color-select">
                        <option value="">Seleccionar color...</option>
                    </select>
                    <input type="number" class="form-control cantidad-input" value="${product.quantity}" min="1" data-index="${index}">
                    <input type="text" class="form-control precio-input" placeholder="$0">
                    <select class="form-control iva-select">
                        <option value="0">0%</option>
                        <option value="10.5">10.5%</option>
                        <option value="21">21%</option>
                    </select>
                    <input type="text" class="form-control subtotal-input" readonly placeholder="$0">
                    <button type="button" class="btn-delete" onclick="removeProduct(this)">Eliminar</button>
                `;
                container.appendChild(productForm);
            });
            
            // Load products and set values
            loadProductsToSelect();
            
            // Set discount if available
            if (order.discount && order.discount.percentage) {
                document.getElementById('discount-input').value = order.discount.percentage;
            } else {
                document.getElementById('discount-input').value = '0';
            }
            
            // Set commission if available
            if (order.commission && order.commission.percentage) {
                document.getElementById('commission-input').value = order.commission.percentage;
            } else {
                document.getElementById('commission-input').value = '0';
            }
            
            // Set product values after a short delay to ensure products are loaded
            setTimeout(() => {
                const productForms = document.querySelectorAll('.product-form');
                order.products.forEach((product, index) => {
                    if (productForms[index]) {
                        const form = productForms[index];
                        const input = form.querySelector('.producto-input');
                        const colorSelect = form.querySelector('.color-select');
                        
                        // Set product name
                        input.value = product.product;
                        
                        // Set IVA value
                        const ivaSelect = form.querySelector('.iva-select');
                        if (product.iva !== undefined) {
                            ivaSelect.value = product.iva.toString();
                        } else {
                            ivaSelect.value = '0';
                        }
                        
                        // Check if it's a known product
                        const knownProduct = products.find(p => p.name.toLowerCase() === product.product.toLowerCase());
                        
                        if (knownProduct) {
                            // Known product - populate colors and make price readonly
                            updateColorDropdown(form, product.product);
                            form.querySelector('.precio-input').readOnly = true;
                            form.querySelector('.precio-input').style.backgroundColor = '#f9fafb';
                        } else {
                            // Manual product - allow manual color and price
                            colorSelect.innerHTML = '<option value="">Escribir color manualmente</option>';
                            if (product.color && product.color !== 'Sin color') {
                                const option = document.createElement('option');
                                option.value = product.color;
                                option.textContent = product.color;
                                colorSelect.appendChild(option);
                            }
                            form.querySelector('.precio-input').readOnly = false;
                            form.querySelector('.precio-input').style.backgroundColor = 'white';
                            form.querySelector('.precio-input').value = product.price;
                        }
                        
                        setTimeout(() => {
                            colorSelect.value = product.color;
                            if (knownProduct) {
                                updatePriceForSelection(form);
                            } else {
                                form.querySelector('.precio-input').value = product.price;
                                updateSubtotalForForm(form);
                            }
                        }, 100);
                    }
                });
            }, 200);
            
            // Switch to new order tab
            switchTab('nuevo-pedido');
        }
        
        // Delete order
        function deleteOrder(orderId) {
            if (confirm('¿Estás seguro de que quieres eliminar este pedido?')) {
                console.log('🗑️ Eliminando pedido con ID:', orderId);
                console.log('📋 Pedidos antes de eliminar:', orders.length);
                
                const originalLength = orders.length;
                
                // Use robust filtering - try multiple ID formats
                orders = orders.filter(o => {
                    // Convert both IDs to strings for comparison
                    const orderIdStr = o.id ? o.id.toString() : '';
                    const targetIdStr = orderId ? orderId.toString() : '';
                    const orderNumeroStr = o.numero ? o.numero.toString() : '';
                    
                    return orderIdStr !== targetIdStr && 
                           orderNumeroStr !== targetIdStr &&
                           o.id != orderId &&
                           o.numero != orderId;
                });
                
                console.log('📋 Pedidos después de eliminar:', orders.length);
                console.log('🎯 Pedidos eliminados:', originalLength - orders.length);
                
                if (orders.length < originalLength) {
                    localStorage.setItem('pedidos', JSON.stringify(orders));
                    console.log('✅ Pedido eliminado exitosamente');
                    
                    // Refresh the appropriate list based on current active tab
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab && activeTab.textContent.includes('Liquidados')) {
                        displayLiquidatedOrdersList();
                    } else {
                        displayOrdersList();
                    }
                } else {
                    console.log('⚠️ No se encontró el pedido para eliminar');
                    alert('⚠️ No se encontró el pedido para eliminar');
                }
            }
        }
        
        // Liquidate order - Improved version
        async function liquidateOrder(orderId) {
            if (confirm('¿Confirmas que has cobrado este pedido? Se marcará como liquidado.')) {
                try {
                    console.log('🔄 Liquidando pedido:', orderId);
                    console.log('- Firebase habilitado:', FIREBASE_CONFIG.ENABLED);
                    
                    let firebaseSuccess = false;
                    
                    // Try Firebase only if enabled
                    if (FIREBASE_CONFIG.ENABLED && window.firebaseService && window.firebaseService.isInitialized) {
                        console.log('🔥 Intentando actualizar en Firebase...');
                        firebaseSuccess = await updateOrderStatusFirebase(orderId, 'Liquidado');
                    } else {
                        console.log('⚠️ Firebase deshabilitado o no disponible, usando solo localStorage');
                    }
                    
                    // Update local array (always do this)
                    console.log('🔍 Buscando pedido con ID:', orderId);
                    console.log('📋 Pedidos disponibles:', orders.length);
                    console.log('📋 Primeros 3 pedidos:', orders.slice(0, 3).map(o => ({
                        id: o.id,
                        numero: o.numero,
                        customer: o.customer?.name || o.cliente?.nombre
                    })));
                    
                    // Try multiple ID formats to find the order
                    let orderIndex = orders.findIndex(o => o.id === orderId);
                    if (orderIndex === -1) {
                        orderIndex = orders.findIndex(o => o.numero === orderId);
                    }
                    if (orderIndex === -1) {
                        orderIndex = orders.findIndex(o => o.id == orderId); // == instead of ===
                    }
                    if (orderIndex === -1) {
                        orderIndex = orders.findIndex(o => o.numero == orderId); // == instead of ===
                    }
                    
                    console.log('🎯 Índice encontrado:', orderIndex);
                    
                    if (orderIndex !== -1) {
                        orders[orderIndex].status = 'Liquidado';
                        orders[orderIndex].liquidationDate = new Date().toISOString();
                        
                        // Update localStorage
                        localStorage.setItem('pedidos', JSON.stringify(orders));
                        
                        // Refresh display
                        displayOrdersList();
                        
                        if (firebaseSuccess) {
                            alert('✅ ¡Pedido liquidado exitosamente!\n🔥 Sincronizado con Firebase');
                        } else {
                            alert('✅ ¡Pedido liquidado exitosamente!\n📱 Guardado localmente');
                        }
                    } else {
                        console.error('❌ No se encontró el pedido con ID:', orderId);
                        alert('❌ Error: No se encontró el pedido');
                    }
                    
                } catch (error) {
                    console.error('❌ Error liquidando pedido:', error);
                    alert('❌ Error al liquidar pedido: ' + error.message);
                }
            }
        }
        
        // Restore order from liquidated to pending - Improved version
        async function restoreOrder(orderId) {
            if (confirm('¿Estás seguro de que quieres restaurar este pedido a pendiente?')) {
                try {
                    console.log('🔄 Restaurando pedido:', orderId);
                    console.log('- Firebase habilitado:', FIREBASE_CONFIG.ENABLED);
                    
                    let firebaseSuccess = false;
                    
                    // Try Firebase only if enabled
                    if (FIREBASE_CONFIG.ENABLED && window.firebaseService && window.firebaseService.isInitialized) {
                        console.log('🔥 Intentando actualizar en Firebase...');
                        firebaseSuccess = await updateOrderStatusFirebase(orderId, 'Pendiente');
                    } else {
                        console.log('⚠️ Firebase deshabilitado o no disponible, usando solo localStorage');
                    }
                    
                    // Update local array (always do this)
                    console.log('🔍 Restaurando pedido con ID:', orderId);
                    console.log('📋 Pedidos disponibles:', orders.length);
                    console.log('📋 Primeros 3 pedidos:', orders.slice(0, 3).map(o => ({
                        id: o.id,
                        numero: o.numero,
                        customer: o.customer?.name || o.cliente?.nombre
                    })));
                    
                    // Try multiple ID formats to find the order
                    let orderIndex = orders.findIndex(o => o.id === orderId);
                    if (orderIndex === -1) {
                        orderIndex = orders.findIndex(o => o.numero === orderId);
                    }
                    if (orderIndex === -1) {
                        orderIndex = orders.findIndex(o => o.id == orderId); // == instead of ===
                    }
                    if (orderIndex === -1) {
                        orderIndex = orders.findIndex(o => o.numero == orderId); // == instead of ===
                    }
                    
                    console.log('🎯 Índice encontrado:', orderIndex);
                    
                    if (orderIndex !== -1) {
                        orders[orderIndex].status = 'Pendiente';
                        delete orders[orderIndex].liquidationDate;
                        
                        // Update localStorage
                        localStorage.setItem('pedidos', JSON.stringify(orders));
                        
                        // Refresh display
                        displayLiquidatedOrdersList();
                        
                        if (firebaseSuccess) {
                            alert('✅ ¡Pedido restaurado exitosamente!\n🔥 Sincronizado con Firebase');
                        } else {
                            alert('✅ ¡Pedido restaurado exitosamente!\n📱 Guardado localmente');
                        }
                    } else {
                        console.error('❌ No se encontró el pedido con ID:', orderId);
                        alert('❌ Error: No se encontró el pedido');
                    }
                    
                } catch (error) {
                    console.error('❌ Error restaurando pedido:', error);
                    alert('❌ Error al restaurar pedido: ' + error.message);
                }
            }
        }
        
        // Display liquidated orders list
        function displayLiquidatedOrdersList() {
            console.log('🔍 DEBUG displayLiquidatedOrdersList - START');
            console.log('- orders variable:', orders);
            console.log('- orders length:', orders.length);
            
            const container = document.getElementById('liquidated-orders-container');
            console.log('- liquidated container found:', !!container);
            
            // Debug each order
            orders.forEach((order, index) => {
                console.log(`- Order ${index}:`, {
                    id: order.id,
                    status: order.status,
                    statusLength: order.status?.length,
                    statusBytes: order.status ? Array.from(order.status).map(c => c.charCodeAt(0)) : null,
                    customer: order.customer?.name,
                    liquidationDate: order.liquidationDate
                });
                
                // Check exact comparison
                console.log(`  - order.status === 'Liquidado': ${order.status === 'Liquidado'}`);
            });
            
            const liquidatedOrders = orders.filter(order => order.status === 'Liquidado');
            console.log('- liquidatedOrders:', liquidatedOrders);
            console.log('- liquidatedOrders length:', liquidatedOrders.length);
            
            if (liquidatedOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">No hay pedidos liquidados aún</p>';
                console.log('- No liquidated orders found, showing message');
                return;
            }
            
            // Sort orders by liquidation date (oldest first)
            liquidatedOrders.sort((a, b) => new Date(a.liquidationDate) - new Date(b.liquidationDate));
            
            let html = '';
            
            liquidatedOrders.forEach(order => {
                // Safe access to customer and order data
                const customer = order.customer || {};
                const orderId = order.id || 'Sin ID';
                const orderStatus = order.status || 'Liquidado';
                const orderTotal = order.total || 0;
                
                // Format dates safely
                let liquidationDate = 'Sin fecha';
                try {
                    if (order.liquidationDate) {
                        liquidationDate = new Date(order.liquidationDate).toLocaleDateString('es-AR', {
                            day: '2-digit',
                            month: '2-digit'
                        });
                    }
                } catch (e) {
                    console.warn('Error formateando fecha de liquidación:', e);
                    liquidationDate = 'Fecha inválida';
                }
                
                html += `
                    <div class="compact-order-item" onclick="toggleOrderDetails(${orderId}, 'liquidated')">
                        <div class="compact-order-main">
                            <div class="compact-order-id">#${orderId}</div>
                            <div class="compact-order-customer">${customer.name || 'Sin nombre'}</div>
                            <div class="compact-order-total">$${formatCurrency(orderTotal)}</div>
                            <div class="order-status status-liquidado">${orderStatus}</div>
                        </div>
                        <div class="compact-order-date">${liquidationDate}</div>
                    </div>
                    <div id="liquidated-details-${orderId}" class="order-details-expanded" style="display: none;">
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-id">#${orderId}</div>
                                <div class="order-status status-liquidado">${orderStatus}</div>
                            </div>
                            
                            <div class="order-info">
                                <div class="info-item">
                                    <div class="info-label">Cliente</div>
                                    <div class="info-value">${customer.name || 'Sin nombre'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Teléfono</div>
                                    <div class="info-value">${customer.phone || 'Sin teléfono'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Fecha Pedido</div>
                                    <div class="info-value">${order.date ? new Date(order.date).toLocaleDateString('es-AR') : 'Sin fecha'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Fecha Liquidación</div>
                                    <div class="info-value">${liquidationDate}</div>
                                </div>
                            </div>
                            
                            ${customer.email ? `
                                <div class="info-item" style="margin-bottom: 8px;">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">${customer.email}</div>
                                </div>
                            ` : ''}
                            
                            ${customer.address ? `
                                <div class="info-item" style="margin-bottom: 16px;">
                                    <div class="info-label">Dirección</div>
                                    <div class="info-value">${customer.address}</div>
                                </div>
                            ` : ''}
                            
                            <div class="order-products">
                                <div class="products-title">Productos</div>
                                ${(order.products || []).map((product, index) => `
                                    <div class="product-item">
                                        ${index + 1}. ${product.product || 'Sin producto'} (${product.color || 'Sin color'}) x${product.quantity || 0} - IVA: ${product.iva || 0}% = $${formatCurrency(product.subtotal)}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="order-total">Subtotal: $${formatCurrency(order.subtotal || order.total || 0)}</div>
                            ${order.discount && order.discount.percentage > 0 ? `
                                <div style="text-align: center; color: #ef4444; margin: 8px 0;">
                                    Descuento ${order.discount.percentage}%: -$${formatCurrency(order.discount.amount || 0)}
                                </div>
                            ` : ''}
                            ${order.commission && order.commission.percentage > 0 ? `
                                <div style="text-align: center; color: #3b82f6; margin: 8px 0;">
                                    Comisión Vendedor ${order.commission.percentage}%: +$${formatCurrency(order.commission.amount || 0)}
                                </div>
                            ` : ''}
                            <div class="order-total">Total Final: $${formatCurrency(orderTotal)}</div>
                            
                            <div class="order-actions">
                                <button class="btn secondary btn-small" onclick="restoreOrder('${orderId}')">Restaurar</button>
                                <button class="btn danger btn-small" onclick="deleteOrder('${orderId}')">Eliminar</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Calculate profits for orders
        function calculateProfits() {
            const filter = document.getElementById('profit-filter').value;
            let ordersToAnalyze = orders;
            
            // Filter orders based on selection
            if (filter === 'liquidated') {
                ordersToAnalyze = orders.filter(order => order.status === 'Liquidado');
            } else if (filter === 'pending') {
                ordersToAnalyze = orders.filter(order => order.status === 'Pendiente');
            }
            
            if (ordersToAnalyze.length === 0) {
                document.getElementById('profit-analysis-container').innerHTML = 
                    '<p style="text-align: center; color: #6b7280; font-style: italic;">No hay pedidos para analizar</p>';
                return;
            }
            
            let totalProfit = 0;
            let totalRevenue = 0;
            let totalCost = 0;
            const orderProfits = [];
            
            ordersToAnalyze.forEach(order => {
                const orderAnalysis = calculateOrderProfit(order);
                if (orderAnalysis) {
                    orderProfits.push(orderAnalysis);
                    totalProfit += orderAnalysis.netProfit;
                    totalRevenue += orderAnalysis.revenue;
                    totalCost += orderAnalysis.baseCost;
                }
            });
            
            // Calculate average margin
            const averageMargin = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100) : 0;
            
            // Update summary cards
            document.getElementById('total-profit').textContent = '$' + totalProfit.toLocaleString('es-AR', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            });
            document.getElementById('average-margin').textContent = averageMargin.toFixed(1) + '%';
            document.getElementById('analyzed-orders').textContent = orderProfits.length;
            
            // Display detailed analysis
            displayProfitAnalysis(orderProfits);
        }
        
        // Calculate profit for a single order
        function calculateOrderProfit(order) {
            let totalRevenue = 0;
            let totalBaseCost = 0;
            let totalCommission = 0;
            const productAnalysis = [];
            
            // Parse the order total to get actual revenue
            const revenueText = order.total.toString().replace(/[^\d]/g, '');
            totalRevenue = parseFloat(revenueText) || 0;
            
            // Calculate commission cost - percentage of total revenue
            const commissionPercentage = (order.commission && order.commission.percentage) ? order.commission.percentage : 0;
            totalCommission = totalRevenue * (commissionPercentage / 100);
            
            order.products.forEach(product => {
                // Find the product in our database to get cost
                const dbProduct = products.find(p => 
                    p.name.toLowerCase() === product.product.toLowerCase() && 
                    p.color.toLowerCase() === product.color.toLowerCase()
                );
                
                // Parse product selling price for commission calculation per product
                const priceText = product.price.toString().replace(/[^\d]/g, '');
                const sellingPrice = parseFloat(priceText) || 0;
                const quantity = product.quantity;
                const productRevenue = sellingPrice * quantity;
                const productCommission = productRevenue * (commissionPercentage / 100);
                
                if (dbProduct && dbProduct.cost) {
                    const unitCost = dbProduct.cost;
                    const productBaseCost = unitCost * quantity;
                    
                    totalBaseCost += productBaseCost;
                    
                    productAnalysis.push({
                        name: product.product,
                        color: product.color,
                        quantity: quantity,
                        price: sellingPrice,
                        unitCost: unitCost,
                        totalCost: productBaseCost,
                        commission: productCommission,
                        revenue: productRevenue
                    });
                } else {
                    // If no cost data, estimate 60% of selling price
                    const estimatedUnitCost = sellingPrice * 0.6;
                    const productBaseCost = estimatedUnitCost * quantity;
                    
                    totalBaseCost += productBaseCost;
                    
                    productAnalysis.push({
                        name: product.product,
                        color: product.color,
                        quantity: quantity,
                        price: sellingPrice,
                        unitCost: estimatedUnitCost,
                        totalCost: productBaseCost,
                        commission: productCommission,
                        revenue: productRevenue,
                        estimated: true
                    });
                }
            });
            
            // Correct calculation: Revenue - Commission - Base Costs = Net Profit
            const netProfit = totalRevenue - totalCommission - totalBaseCost;
            const margin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100) : 0;
            
            return {
                order: order,
                revenue: totalRevenue,
                baseCost: totalBaseCost,
                commissionAmount: totalCommission,
                netRevenue: totalRevenue - totalCommission,
                netProfit: netProfit,
                margin: margin,
                products: productAnalysis
            };
        }
        
        // Display profit analysis results
        function displayProfitAnalysis(orderProfits) {
            const container = document.getElementById('profit-analysis-container');
            
            if (orderProfits.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">No se pudieron calcular ganancias</p>';
                return;
            }
            
            // Sort by date (oldest first) - consistent with other lists
            orderProfits.sort((a, b) => new Date(a.order.date) - new Date(b.order.date));
            
            let html = '';
            
            orderProfits.forEach(analysis => {
                const order = analysis.order;
                const profitClass = analysis.netProfit >= 0 ? 'profit-positive' : 'profit-negative';
                
                html += `
                    <div class="profit-order-item">
                        <div class="profit-order-header">
                            <div>
                                <strong>#${order.id}</strong> - ${order.customer.name}
                                <span class="order-status status-${order.status.toLowerCase()}" style="margin-left: 10px;">${order.status}</span>
                            </div>
                            <div style="font-size: 12px; color: #64748b;">
                                ${new Date(order.date).toLocaleDateString('es-AR')}
                            </div>
                        </div>
                        
                        <div class="profit-order-details">
                            <div class="profit-detail-item">
                                <div class="profit-detail-label">Ingresos Brutos</div>
                                <div class="profit-detail-value">$${analysis.revenue.toLocaleString('es-AR')}</div>
                            </div>
                            <div class="profit-detail-item">
                                <div class="profit-detail-label">Comisión (${order.commission || 0}%)</div>
                                <div class="profit-detail-value" style="color: #ef4444;">-$${analysis.commissionAmount.toLocaleString('es-AR')}</div>
                            </div>
                            <div class="profit-detail-item">
                                <div class="profit-detail-label">Ingresos Netos</div>
                                <div class="profit-detail-value" style="color: #059669;">$${analysis.netRevenue.toLocaleString('es-AR')}</div>
                            </div>
                            <div class="profit-detail-item">
                                <div class="profit-detail-label">Costos Base</div>
                                <div class="profit-detail-value" style="color: #ef4444;">-$${analysis.baseCost.toLocaleString('es-AR')}</div>
                            </div>
                            <div class="profit-detail-item">
                                <div class="profit-detail-label">Ganancia Neta</div>
                                <div class="profit-detail-value ${profitClass}">$${analysis.netProfit.toLocaleString('es-AR')}</div>
                            </div>
                            <div class="profit-detail-item">
                                <div class="profit-detail-label">Margen</div>
                                <div class="profit-detail-value ${profitClass}">${analysis.margin.toFixed(1)}%</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <strong style="font-size: 14px; color: #374151;">Desglose por producto:</strong>
                            <div style="margin-top: 8px;">
                                ${analysis.products.map(prod => `
                                    <div style="padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                            <span style="font-size: 13px; font-weight: 600;">${prod.name} (${prod.color}) x${prod.quantity}</span>
                                            <span style="font-size: 13px; font-weight: 600;">
                                                Costo: $${prod.totalCost.toLocaleString('es-AR')}
                                                ${prod.estimated ? '<span style="color: #f59e0b;">(estimado)</span>' : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #64748b;">
                                            <span>Precio: $${(prod.price * prod.quantity).toLocaleString('es-AR')}</span>
                                            <span>Ganancia: $${(prod.price * prod.quantity - prod.totalCost).toLocaleString('es-AR')}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Debug function to check localStorage - Enhanced
        function debugLocalStorage() {
            console.log('🔍 Debug localStorage MEJORADO:');
            console.log('- Contenido completo de localStorage:', {...localStorage});
            console.log('- Pedidos en memoria:', orders);
            console.log('- Pedidos en localStorage (raw):', localStorage.getItem('pedidos'));
            
            // Check if localStorage is working
            try {
                localStorage.setItem('test_debug', 'test_value');
                const testValue = localStorage.getItem('test_debug');
                localStorage.removeItem('test_debug');
                console.log('- localStorage funciona:', testValue === 'test_value');
            } catch (e) {
                console.error('- ERROR: localStorage no funciona:', e);
            }
            
            // Try to parse and show structure
            try {
                const saved = localStorage.getItem('pedidos');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    console.log('- Pedidos parseados:', parsed);
                    console.log('- Cantidad de pedidos guardados:', Array.isArray(parsed) ? parsed.length : 'No es array');
                    console.log('- Tipo de datos:', typeof parsed);
                } else {
                    console.log('- No hay datos de pedidos en localStorage');
                }
            } catch (e) {
                console.error('- Error parseando pedidos:', e);
            }
            
            // Show DOM container state
            const container = document.getElementById('orders-container');
            console.log('- Container de pedidos existe:', !!container);
            if (container) {
                console.log('- Contenido del container:', container.innerHTML.substring(0, 200) + '...');
            }
        }

        // Test function to create a sample order
        function createTestOrder() {
            console.log('🧪 Creando pedido de prueba...');
            
            const testOrder = {
                id: Date.now(),
                date: new Date().toLocaleString('es-AR'),
                customer: {
                    name: 'Cliente Prueba',
                    phone: '123456789',
                    email: 'test@test.com',
                    address: 'Dirección de prueba'
                },
                products: [{
                    product: 'Producto Prueba',
                    color: 'Rojo',
                    quantity: 1,
                    price: '$1000',
                    iva: 0,
                    subtotal: '$1000'
                }],
                subtotal: '1000',
                discount: { percentage: 0, amount: '0' },
                commission: { percentage: 0, amount: '0' },
                total: '1000',
                fechaPedido: new Date().toISOString().slice(0, 16),
                status: 'Pendiente'
            };
            
            orders.push(testOrder);
            
            try {
                localStorage.setItem('pedidos', JSON.stringify(orders));
                console.log('✅ Pedido de prueba creado y guardado');
                console.log('📋 Total pedidos:', orders.length);
                
                // Refresh display
                displayOrdersList();
                
            } catch (error) {
                console.error('❌ Error creando pedido de prueba:', error);
            }
        }

        // Force save orders to localStorage
        function forceSaveOrders() {
            try {
                localStorage.setItem('pedidos', JSON.stringify(orders));
                console.log('✅ Pedidos guardados forzadamente:', orders);
                debugLocalStorage();
            } catch (error) {
                console.error('❌ Error guardando pedidos:', error);
            }
        }

        // Force reload products - Emergency function
        function forceReloadProducts() {
            console.log('🔄 Forzando recarga de productos...');
            
            // First try Google Sheets
            if (GOOGLE_CONFIG.ENABLED) {
                console.log('📡 Intentando Google Sheets...');
                testGoogleSheets();
            } else {
                console.log('📦 Google Sheets deshabilitado, cargando productos por defecto');
                loadDefaultProducts();
            }
        }

        // Force load and display orders - Emergency function
        function forceLoadAndDisplayOrders() {
            console.log('🚨 FORCE LOAD AND DISPLAY - START');
            
            // 1. Force load from localStorage
            const savedOrders = localStorage.getItem('pedidos');
            console.log('- Raw data:', savedOrders);
            
            if (savedOrders) {
                try {
                    const parsed = JSON.parse(savedOrders);
                    orders = parsed;
                    window.orders = orders;
                    console.log('- Forced orders update:', orders);
                } catch (e) {
                    console.error('- Parse error:', e);
                }
            }
            
            // 2. Force display
            console.log('- Forcing display with orders:', orders);
            displayOrdersList();
            
            console.log('🚨 FORCE LOAD AND DISPLAY - END');
        }

        // Force load orders from localStorage
        function forceLoadOrders() {
            console.log('🔄 Carga forzada de pedidos...');
            loadOrders();
            displayOrdersList();
            console.log('📋 Pedidos después de carga forzada:', orders);
        }

        // Load orders from localStorage on startup
        function loadOrders() {
            console.log('🔍 DEBUG loadOrders - START');
            try {
                const savedOrders = localStorage.getItem('pedidos');
                console.log('- Raw localStorage data:', savedOrders);
                
                if (savedOrders && savedOrders !== 'null' && savedOrders !== 'undefined') {
                    const parsedOrders = JSON.parse(savedOrders);
                    console.log('- Parsed orders:', parsedOrders);
                    console.log('- Is array:', Array.isArray(parsedOrders));
                    
                    if (Array.isArray(parsedOrders)) {
                        orders = parsedOrders;
                        
                        // Clean corrupted orders
                        const originalLength = orders.length;
                        orders = orders.filter(order => {
                            // Remove orders with undefined id or completely empty orders
                            const isValid = order && 
                                           (order.id !== undefined && order.id !== null && order.id !== '') &&
                                           (order.customer !== undefined || order.cliente !== undefined);
                            
                            if (!isValid) {
                                console.log('🗑️ Removing corrupted order:', order);
                            }
                            return isValid;
                        });
                        
                        // Normalize ID types - ensure all IDs are strings
                        orders = orders.map(order => {
                            if (order.id && typeof order.id !== 'string') {
                                order.id = order.id.toString();
                                console.log('🔧 Normalized ID to string:', order.id);
                            }
                            return order;
                        });
                        
                        // Save cleaned data back to localStorage if we removed anything
                        if (orders.length !== originalLength) {
                            console.log(`🧹 Cleaned ${originalLength - orders.length} corrupted orders`);
                            localStorage.setItem('pedidos', JSON.stringify(orders));
                        }
                        
                        window.orders = orders; // Make sure global is updated
                        console.log(`📦 Se cargaron ${orders.length} pedidos desde localStorage:`, orders);
                        
                        // Debug each order's status
                        orders.forEach((order, index) => {
                            console.log(`- Order ${index} status: "${order.status}" (type: ${typeof order.status})`);
                        });
                        
                    } else {
                        console.warn('📦 Datos de pedidos no válidos en localStorage, inicializando array vacío');
                        orders = [];
                        window.orders = [];
                    }
                } else {
                    console.log('📦 No hay pedidos guardados en localStorage');
                    orders = [];
                    window.orders = [];
                }
            } catch (error) {
                console.error('❌ Error cargando pedidos desde localStorage:', error);
                orders = [];
                window.orders = [];
                // Try to clear corrupted data
                localStorage.removeItem('pedidos');
            }
            console.log('🔍 DEBUG loadOrders - END, orders final:', orders);
        }

        // Load orders from Google Sheets
        async function loadOrdersFromGoogleSheets() {
            if (!GOOGLE_CONFIG.ENABLED) {
                console.log('📊 Google Sheets deshabilitado - usando solo localStorage');
                return;
            }

            try {
                console.log('📊 Cargando pedidos desde Google Sheets...');
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SHEETS_ID}/values/${GOOGLE_CONFIG.ORDERS_RANGE}?key=${GOOGLE_CONFIG.API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 Datos recibidos de Google Sheets:', data);
                
                if (data.values && data.values.length > 0) {
                    // Skip header row if exists
                    const rows = data.values.slice(1);
                    const sheetsOrders = [];
                    
                    rows.forEach((row, index) => {
                        try {
                            if (row.length >= 6) { // Ensure minimum columns
                                const order = {
                                    id: row[0] || `sheet-${Date.now()}-${index}`,
                                    date: row[1] || new Date().toISOString().slice(0, 16),
                                    customer: {
                                        name: row[2] || 'Cliente',
                                        phone: row[3] || '',
                                        email: row[4] || ''
                                    },
                                    total: parseFloat(row[5]) || 0,
                                    status: row[6] || 'Pendiente',
                                    products: row[7] ? JSON.parse(row[7]) : [],
                                    source: 'sheets'
                                };
                                sheetsOrders.push(order);
                            }
                        } catch (error) {
                            console.warn(`⚠️ Error parseando fila ${index}:`, error);
                        }
                    });
                    
                    console.log(`📊 Se cargaron ${sheetsOrders.length} pedidos desde Google Sheets`);
                    
                    // Merge with local orders (sheets takes priority)
                    const mergedOrders = mergeOrders(sheetsOrders, orders);
                    orders = mergedOrders;
                    window.orders = orders;
                    
                    // Save merged orders locally
                    localStorage.setItem('pedidos', JSON.stringify(orders));
                    
                    console.log(`📊 Total pedidos después de sincronización: ${orders.length}`);
                    
                } else {
                    console.log('📊 No hay pedidos en Google Sheets');
                }
                
            } catch (error) {
                console.error('❌ Error cargando pedidos desde Google Sheets:', error);
                console.log('📊 Usando pedidos de localStorage como respaldo');
            }
        }

        // Merge orders from different sources
        function mergeOrders(sheetsOrders, localOrders) {
            const merged = [...sheetsOrders];
            
            // Add local orders that are not in sheets
            localOrders.forEach(localOrder => {
                if (!merged.find(order => order.id === localOrder.id)) {
                    merged.push(localOrder);
                }
            });
            
            // Sort by date (newest first)
            return merged.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Save order to Google Sheets
        async function saveOrderToGoogleSheets(order) {
            if (!GOOGLE_CONFIG.ENABLED || !GOOGLE_CONFIG.WRITE_ENABLED) {
                console.log('📝 Google Sheets escritura deshabilitada');
                return { success: false, reason: 'disabled' };
            }

            try {
                console.log('📝 Guardando pedido en Google Sheets...', order.id);
                
                // Prepare row data
                const rowData = [
                    order.id.toString(),
                    order.date,
                    order.customer.name,
                    order.customer.phone,
                    order.customer.email || '',
                    order.total.toString(),
                    order.status,
                    JSON.stringify(order.products)
                ];
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SHEETS_ID}/values/${GOOGLE_CONFIG.ORDERS_RANGE}:append?valueInputOption=RAW&key=${GOOGLE_CONFIG.API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        values: [rowData]
                    })
                });
                
                if (response.ok) {
                    console.log('✅ Pedido guardado exitosamente en Google Sheets');
                    return { success: true };
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('❌ Error guardando pedido en Google Sheets:', error);
                return { success: false, error: error.message };
            }
        }

        // Inventory Management Functions
        
        // Load inventory data from Google Sheets
        async function loadInventoryData() {
            try {
                // Update button state
                const updateBtn = document.querySelector('button[onclick="loadInventoryData()"]');
                if (updateBtn) {
                    updateBtn.innerHTML = '🔄 Cargando...';
                    updateBtn.disabled = true;
                }
                
                // Load fresh data from Google Sheets (but don't affect current display)
                const results = document.getElementById('test-results');
                if (results) {
                    results.innerHTML = '🔄 Actualizando inventario desde Google Sheets...';
                }
                
                try {
                    const GOOGLE_SHEETS_ID = "1yVjDyz7aXnW5BIyVoe3y7bFsrJGR3pVUwtnI43PprAg";
                    const GOOGLE_SHEETS_API_KEY = "AIzaSyCfPL8M1wIFMKxBOkTPsuwAbiyEMXk8Zvw";
                    const GOOGLE_SHEETS_RANGE = "stock!A1:F"; // A=CODIGO, B=COLOR, C=STOCK, D=PRECIO, E=BANDEJA, F=COSTOS
                    
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_ID}/values/${GOOGLE_SHEETS_RANGE}?key=${GOOGLE_SHEETS_API_KEY}`;
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Update products data
                    products = parseGoogleSheetsData(data.values);
                    
                    if (results) {
                        results.innerHTML = `✅ Inventario actualizado desde Google Sheets!<br>📊 Se cargaron ${products.length} productos`;
                    }
                    
                    // Update product selects without affecting orders
                    loadProductsToSelect();
                    
                } catch (error) {
                    console.error('Error:', error);
                    if (results) {
                        results.innerHTML = `❌ Error conectando con Google Sheets: ${error.message}`;
                    }
                    throw error;
                }
                
                // Display inventory table
                displayInventoryTable();
                
                // Update summary cards
                updateInventorySummary();
                
                console.log('✅ Inventario cargado exitosamente');
                
            } catch (error) {
                console.error('❌ Error cargando inventario:', error);
                alert('Error cargando el inventario. Revisa la conexión con Google Sheets.');
            } finally {
                // Reset button state
                const updateBtn = document.querySelector('button[onclick="loadInventoryData()"]');
                if (updateBtn) {
                    updateBtn.innerHTML = '🔄 Actualizar Inventario';
                    updateBtn.disabled = false;
                }
            }
        }
        
        // Display inventory table
        function displayInventoryTable() {
            const tableBody = document.getElementById('inventory-table-body');
            
            if (!products || products.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 40px; text-align: center; color: #ef4444; font-style: italic;">
                            No se pudieron cargar los productos. Verifica la conexión con Google Sheets.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort products by name and then by color
            const sortedProducts = [...products].sort((a, b) => {
                const nameCompare = a.name.localeCompare(b.name);
                if (nameCompare === 0) {
                    return a.color.localeCompare(b.color);
                }
                return nameCompare;
            });
            
            let html = '';
            
            sortedProducts.forEach(product => {
                const stockValue = product.price * product.stock;
                const stockStatus = getStockStatus(product.stock);
                const stockStatusClass = getStockStatusClass(product.stock);
                
                html += `
                    <tr style="border-bottom: 1px solid #f1f5f9; transition: background-color 0.2s ease;" 
                        onmouseover="this.style.backgroundColor='#f8fafc'" 
                        onmouseout="this.style.backgroundColor='white'">
                        <td style="padding: 16px 12px; font-weight: 600; color: #1f2937;">${product.name}</td>
                        <td style="padding: 16px 12px;">
                            <span style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); 
                                         padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                                ${product.color}
                            </span>
                        </td>
                        <td style="padding: 16px 12px; text-align: center; font-weight: 600; color: #059669;">
                            $${product.price.toLocaleString('es-AR')}
                        </td>
                        <td style="padding: 16px 12px; text-align: center; color: #6b7280;">
                            $${product.cost.toLocaleString('es-AR')}
                        </td>
                        <td style="padding: 16px 12px; text-align: center; font-weight: 700; font-size: 16px;">
                            ${product.stock}
                        </td>
                        <td style="padding: 16px 12px; text-align: center; font-weight: 600; color: #4f46e5;">
                            $${stockValue.toLocaleString('es-AR')}
                        </td>
                        <td style="padding: 16px 12px; text-align: center;">
                            <span ${stockStatusClass}>${stockStatus}</span>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // Get stock status text
        function getStockStatus(stock) {
            if (stock === 0) return 'Agotado';
            if (stock <= 5) return 'Bajo';
            if (stock <= 15) return 'Medio';
            return 'Alto';
        }
        
        // Get stock status CSS class
        function getStockStatusClass(stock) {
            const baseStyle = 'padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase;';
            
            if (stock === 0) {
                return `style="${baseStyle} background: #fee2e2; color: #dc2626;"`;
            }
            if (stock <= 5) {
                return `style="${baseStyle} background: #fef3c7; color: #d97706;"`;
            }
            if (stock <= 15) {
                return `style="${baseStyle} background: #dbeafe; color: #2563eb;"`;
            }
            return `style="${baseStyle} background: #d1fae5; color: #059669;"`;
        }
        
        // Update inventory summary cards
        function updateInventorySummary() {
            if (!products || products.length === 0) {
                document.getElementById('total-products').textContent = '0';
                document.getElementById('total-stock').textContent = '0';
                document.getElementById('out-of-stock').textContent = '0';
                document.getElementById('inventory-value').textContent = '$0';
                return;
            }
            
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, product) => sum + product.stock, 0);
            const outOfStock = products.filter(product => product.stock === 0).length;
            const inventoryValue = products.reduce((sum, product) => sum + (product.price * product.stock), 0);
            
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('total-stock').textContent = totalStock.toLocaleString('es-AR');
            document.getElementById('out-of-stock').textContent = outOfStock;
            document.getElementById('inventory-value').textContent = '$' + inventoryValue.toLocaleString('es-AR');
        }
        
        // Filter inventory based on search
        function filterInventory() {
            const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
            const tableRows = document.querySelectorAll('#inventory-table-body tr');
            
            tableRows.forEach(row => {
                const productName = row.children[0]?.textContent.toLowerCase() || '';
                const productColor = row.children[1]?.textContent.toLowerCase() || '';
                
                if (productName.includes(searchTerm) || productColor.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Export inventory to CSV
        function exportInventoryToCSV() {
            if (!products || products.length === 0) {
                alert('No hay datos de inventario para exportar');
                return;
            }
            
            // CSV headers
            const headers = ['Producto', 'Color', 'Precio', 'Costo', 'Stock', 'Valor Stock', 'Estado'];
            const csvContent = [headers.join(',')];
            
            // Add product data
            products.forEach(product => {
                const stockValue = product.price * product.stock;
                const stockStatus = getStockStatus(product.stock);
                
                const row = [
                    `"${product.name}"`,
                    `"${product.color}"`,
                    product.price,
                    product.cost,
                    product.stock,
                    stockValue,
                    `"${stockStatus}"`
                ];
                
                csvContent.push(row.join(','));
            });
            
            // Create and download CSV file
            const csv = csvContent.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `inventario_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Emergency Recovery Functions - Sistema de diagnóstico profundo
        function emergencyDiagnosis() {
            console.log('🚨 DIAGNÓSTICO PROFUNDO DE EMERGENCIA 🚨');
            console.log('='.repeat(50));
            
            // 1. Verificar estado básico de localStorage
            console.log('1️⃣ VERIFICACIÓN BÁSICA DE LOCALSTORAGE:');
            try {
                const testKey = 'emergency_test_' + Date.now();
                localStorage.setItem(testKey, 'test_value');
                const testValue = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                console.log('   ✅ localStorage funciona correctamente');
                console.log('   📊 Capacidad disponible: ' + (localStorage.length + ' items'));
            } catch (e) {
                console.error('   ❌ localStorage NO funciona:', e);
                return;
            }
            
            // 2. Examinar todo el contenido de localStorage
            console.log('\n2️⃣ CONTENIDO COMPLETO DE LOCALSTORAGE:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`   🔑 ${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`);
            }
            
            // 3. Verificar específicamente los pedidos
            console.log('\n3️⃣ ANÁLISIS ESPECÍFICO DE PEDIDOS:');
            const pedidosRaw = localStorage.getItem('pedidos');
            console.log('   📄 Datos raw de pedidos:', pedidosRaw);
            console.log('   📏 Tamaño de datos (caracteres):', pedidosRaw ? pedidosRaw.length : 0);
            console.log('   🔢 Tipo de datos:', typeof pedidosRaw);
            
            if (pedidosRaw) {
                try {
                    const parsed = JSON.parse(pedidosRaw);
                    console.log('   ✅ JSON válido');
                    console.log('   📊 Tipo parseado:', typeof parsed);
                    console.log('   📊 Es array:', Array.isArray(parsed));
                    console.log('   📊 Cantidad de items:', parsed.length);
                    console.log('   📄 Contenido completo:', parsed);
                } catch (e) {
                    console.error('   ❌ JSON inválido:', e);
                }
            } else {
                console.log('   ⚠️ No hay datos de pedidos en localStorage');
            }
            
            // 4. Verificar variable global orders
            console.log('\n4️⃣ ESTADO DE VARIABLE GLOBAL orders:');
            console.log('   📊 Tipo:', typeof orders);
            console.log('   📊 Es array:', Array.isArray(orders));
            console.log('   📊 Cantidad:', orders ? orders.length : 'undefined');
            console.log('   📄 Contenido:', orders);
            
            // 5. Verificar DOM
            console.log('\n5️⃣ VERIFICACIÓN DEL DOM:');
            const container = document.getElementById('orders-container');
            console.log('   📦 Container existe:', !!container);
            if (container) {
                console.log('   📄 HTML actual:', container.innerHTML.substring(0, 200));
            }
            
            // 6. Verificar eventos
            console.log('\n6️⃣ VERIFICACIÓN DE EVENTOS:');
            console.log('   🔄 DOMContentLoaded ya ejecutado:', document.readyState);
            console.log('   🎯 Tab actual activo:', document.querySelector('.tab.active')?.textContent);
            
            console.log('\n' + '='.repeat(50));
            console.log('🏁 DIAGNÓSTICO COMPLETADO');
        }
        
        // Función de reparación de emergencia
        function emergencyRepair() {
            console.log('🔧 INICIANDO REPARACIÓN DE EMERGENCIA');
            
            // 1. Limpiar localStorage completamente
            console.log('🧹 Limpiando localStorage...');
            localStorage.clear();
            
            // 2. Reinicializar variable orders
            console.log('🔄 Reinicializando variable orders...');
            orders = [];
            
            // 3. Crear pedido de prueba
            console.log('🎯 Creando pedido de prueba...');
            const testOrder = {
                id: Date.now(),
                date: new Date().toLocaleString('es-AR'),
                customer: {
                    name: 'Cliente de Prueba',
                    phone: '123456789',
                    email: 'test@test.com',
                    address: 'Dirección de prueba'
                },
                products: [{
                    product: 'Producto de Prueba',
                    color: 'Rojo',
                    quantity: 1,
                    price: '$1000',
                    iva: 0,
                    subtotal: '$1000'
                }],
                subtotal: '1000',
                total: '1000',
                status: 'Pendiente'
            };
            
            // 4. Guardar pedido de prueba
            orders.push(testOrder);
            localStorage.setItem('pedidos', JSON.stringify(orders));
            
            // 5. Verificar
            const saved = localStorage.getItem('pedidos');
            const parsed = JSON.parse(saved);
            
            console.log('✅ Reparación completada');
            console.log('📊 Pedidos guardados:', parsed.length);
            console.log('📄 Contenido:', parsed);
            
            // 6. Actualizar display
            displayOrdersList();
            
            alert('🔧 Reparación de emergencia completada!\n\n✅ Sistema reinicializado\n📦 Pedido de prueba creado\n🔄 Lista actualizada');
        }

        // Sincronización manual con Google Sheets
        async function syncWithGoogleSheets() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            try {
                btn.innerHTML = '🔄 Sincronizando...';
                btn.disabled = true;
                
                console.log('☁️ Iniciando sincronización manual con Google Sheets...');
                
                // Cargar pedidos desde Google Sheets
                await loadOrdersFromGoogleSheets();
                
                // Actualizar la visualización
                displayOrdersList();
                
                btn.innerHTML = '✅ Sincronizado';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
                
                alert(`✅ Sincronización completada!\n\n📊 Total de pedidos: ${orders.length}\n🔄 Datos actualizados desde Google Sheets`);
                
            } catch (error) {
                console.error('❌ Error en sincronización:', error);
                btn.innerHTML = '❌ Error';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
                
                alert('❌ Error en la sincronización:\n\n' + error.message);
            }
        }

        // Debug configuration function
        function showConfigDebug() {
            console.log('🔍 DEBUG - Estado completo de configuración:');
            console.log('GOOGLE_CONFIG:', GOOGLE_CONFIG);
            
            const debugInfo = `
🔍 DEBUG CONFIGURACIÓN:

📊 GOOGLE_CONFIG.ENABLED: ${GOOGLE_CONFIG.ENABLED}
📝 GOOGLE_CONFIG.WRITE_ENABLED: ${GOOGLE_CONFIG.WRITE_ENABLED}
🆔 GOOGLE_CONFIG.SHEETS_ID: ${GOOGLE_CONFIG.SHEETS_ID}
🔑 GOOGLE_CONFIG.API_KEY: ${GOOGLE_CONFIG.API_KEY ? 'Configurado' : 'NO configurado'}
📄 GOOGLE_CONFIG.ORDERS_RANGE: ${GOOGLE_CONFIG.ORDERS_RANGE}
📦 GOOGLE_CONFIG.STOCK_RANGE: ${GOOGLE_CONFIG.STOCK_RANGE}

❌ GOOGLE_CONFIG.ERROR_COUNT: ${GOOGLE_CONFIG.ERROR_COUNT}
⚠️ GOOGLE_CONFIG.MAX_ERRORS: ${GOOGLE_CONFIG.MAX_ERRORS}

🧮 Condición de escritura: (!ENABLED || !WRITE_ENABLED) = ${(!GOOGLE_CONFIG.ENABLED || !GOOGLE_CONFIG.WRITE_ENABLED)}

✅ Escritura disponible: ${GOOGLE_CONFIG.ENABLED && GOOGLE_CONFIG.WRITE_ENABLED ? 'SÍ' : 'NO'}
            `;
            
            alert(debugInfo);
            updateConfigStatus(); // Refresh status display
        }
        
        // Función de recuperación de datos
        function attemptDataRecovery() {
            console.log('🔍 INTENTANDO RECUPERACIÓN DE DATOS');
            
            // Buscar en todas las posibles ubicaciones
            const possibleKeys = ['pedidos', 'orders', 'pedidosGa', 'ordenes', 'backup_pedidos'];
            
            for (const key of possibleKeys) {
                const data = localStorage.getItem(key);
                if (data && data !== 'null' && data !== 'undefined') {
                    console.log(`🎯 Datos encontrados en clave "${key}":`, data);
                    
                    try {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            console.log(`✅ Datos válidos encontrados en "${key}"!`);
                            orders = parsed;
                            localStorage.setItem('pedidos', JSON.stringify(orders));
                            displayOrdersList();
                            alert(`🎉 ¡Datos recuperados!\n\nEncontrados ${orders.length} pedidos en la clave "${key}"`);
                            return;
                        }
                    } catch (e) {
                        console.log(`❌ Datos corruptos en "${key}":`, e);
                    }
                }
            }
            
            console.log('😞 No se encontraron datos recuperables');
            alert('😞 No se encontraron datos recuperables en localStorage');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Test app initialized - FAST MODE with Google Sheets sync');
            
            // Update configuration status display
            updateConfigStatus();
            
            // FIRST: Load orders immediately from localStorage
            console.log('🔄 Loading orders from localStorage FIRST...');
            loadOrders();
            console.log('📋 Orders after immediate load:', orders);
            
            // THEN: Load and merge from Google Sheets
            console.log('🔄 Loading orders from Google Sheets...');
            loadOrdersFromGoogleSheets().then(() => {
                console.log('📋 Orders after Google Sheets sync:', orders);
                // Refresh display after sync
                displayOrdersList();
            }).catch(error => {
                console.error('❌ Error syncing with Google Sheets:', error);
            });
            
            // THEN: Execute emergency diagnosis
            emergencyDiagnosis();
            
            // Debug localStorage again
            debugLocalStorage();
            
            // Display the orders list immediately after loading
            console.log('🎯 Displaying orders list...');
            displayOrdersList();
            console.log('📋 Lista de pedidos inicializada con', orders.length, 'pedidos');
            
            // Load Google Sheets data
            testGoogleSheets();
            
            // Start queue processor (runs every 30 seconds)
            setInterval(() => {
                if (orderQueue.length > 0) {
                    console.log(`🔄 Procesando cola automática (${orderQueue.length} elementos pendientes)`);
                    processQueue();
                }
            }, 30000);
            
            console.log('🚀 Sistema de cola de sincronización iniciado');
        });
        
        // Toggle Google Sheets functionality
        function toggleGoogleSheets() {
            GOOGLE_CONFIG.ENABLED = !GOOGLE_CONFIG.ENABLED;
            GOOGLE_CONFIG.ERROR_COUNT = 0; // Reset error count
            
            updateGoogleSheetsStatus();
            
            if (GOOGLE_CONFIG.ENABLED) {
                showNotification('🟢 Google Sheets habilitado', 'success');
                // Test connection when enabled
                setTimeout(() => testGoogleSheets(), 1000);
            } else {
                showNotification('🔴 Google Sheets deshabilitado', 'info');
            }
        }

        // Update Google Sheets status display
        function updateGoogleSheetsStatus() {
            const statusElement = document.getElementById('google-sheets-status');
            const toggleButton = document.getElementById('toggle-sheets-btn');
            
            if (GOOGLE_CONFIG.ENABLED) {
                statusElement.innerHTML = '🟢 HABILITADO';
                statusElement.style.cssText = 'padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #d1fae5; color: #059669;';
                toggleButton.innerHTML = '🔴 Deshabilitar';
                toggleButton.style.cssText = 'background: #dc2626; border-color: #dc2626; font-size: 12px;';
            } else {
                statusElement.innerHTML = '🔴 DESHABILITADO';
                statusElement.style.cssText = 'padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #fee2e2; color: #dc2626;';
                toggleButton.innerHTML = '🟢 Habilitar';
                toggleButton.style.cssText = 'background: #059669; border-color: #059669; font-size: 12px;';
            }
        }

        // Initialize Google Sheets status on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateGoogleSheetsStatus();
        });

        // Check sync queue status
        function checkSyncQueue() {
            const queueStatus = document.getElementById('queue-status');
            const queueDetails = document.getElementById('queue-details');
            
            queueStatus.style.display = 'block';
            
            let details = `
                <div>📊 Operaciones en cola: <strong>${orderQueue.length}</strong></div>
                <div>🔄 Procesando: <strong>${isProcessingQueue ? 'Sí' : 'No'}</strong></div>
                <div>⏰ Última actualización: <strong>${new Date().toLocaleTimeString()}</strong></div>
            `;
            
            if (orderQueue.length > 0) {
                details += '<div style="margin-top: 8px; font-weight: bold;">Operaciones pendientes:</div>';
                orderQueue.forEach((op, index) => {
                    details += `<div>• ${index + 1}. ${op.action === 'write' ? '📝 Escribir pedido' : '📦 Actualizar stock'}</div>`;
                });
            }
            
            queueDetails.innerHTML = details;
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                queueStatus.style.display = 'none';
            }, 10000);
        }
        
        // Force sync queue processing
        async function forceSyncQueue() {
            if (orderQueue.length === 0) {
                alert('📋 No hay operaciones pendientes en la cola');
                return;
            }
            
            if (isProcessingQueue) {
                alert('⚠️ Ya se está procesando la cola');
                return;
            }
            
            alert(`🔄 Forzando procesamiento de ${orderQueue.length} operaciones...`);
            
            try {
                await processQueue();
                alert('✅ Cola procesada exitosamente');
                checkSyncQueue(); // Update display
            } catch (error) {
                alert(`❌ Error procesando la cola: ${error.message}`);
            }
        }
        
        // Test if "pedidos" sheet exists and is properly configured
        async function testPedidosSheet() {
            const results = document.getElementById('test-results');
            results.innerHTML = '🔄 Verificando hoja "pedidos"...';
            
            try {
                // Try to read from the pedidos sheet
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SHEETS_ID}/values/${GOOGLE_CONFIG.ORDERS_RANGE}?key=${GOOGLE_CONFIG.API_KEY}`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.values && data.values.length > 0) {
                        results.innerHTML = `✅ Hoja "pedidos" configurada correctamente<br>📊 ${data.values.length - 1} pedidos encontrados`;
                    } else {
                        results.innerHTML = `⚠️ Hoja "pedidos" existe pero está vacía<br>💡 La app creará los encabezados automáticamente al crear el primer pedido`;
                    }
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Error verificando hoja pedidos:', error);
                results.innerHTML = `❌ Error verificando hoja "pedidos": ${error.message}<br><br>📖 <strong>Solución:</strong> Crea manualmente una hoja llamada "pedidos" en tu Google Sheets`;
            }
        }
        
        // Show Google Sheets setup instructions
        function showGoogleSheetsInstructions() {
            const instructions = `
🔧 INSTRUCCIONES PARA CONFIGURAR GOOGLE SHEETS

📋 **Paso 1: Crear la hoja "pedidos"**
1. Ve a tu Google Sheets: https://docs.google.com/spreadsheets/d/${GOOGLE_CONFIG.SHEETS_ID}
2. Haz clic derecho en la pestaña de una hoja existente
3. Selecciona "Insertar hoja"
4. Nómbrala exactamente: "pedidos" (sin mayúsculas)

📊 **Paso 2: Configurar los encabezados**
En la fila 1, escribe:
A1: ID
B1: Fecha  
C1: Cliente
D1: Teléfono
E1: Email
F1: Total
G1: Estado
H1: Productos

🚀 **Paso 3: Verificar**
Haz clic en "🔍 Verificar Hoja pedidos" para confirmar que todo está configurado correctamente.

💡 **Nota:** La app escribirá automáticamente los pedidos en esta hoja.
            `;
            
            alert(instructions);
        }

        // Show Firebase Firestore rules
        function showFirebaseRules() {
            const rules = `
🔥 REGLAS DE FIRESTORE PARA ACCESO UNIVERSAL

📋 **Copia y pega estas reglas en Firebase Console:**

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Permitir acceso completo a pedidos
    match /pedidos/{document} {
      allow read, write: if true;
    }
    
    // Permitir acceso completo a productos
    match /productos/{document} {
      allow read, write: if true;
    }
    
    // Permitir acceso para testing
    match /test/{document} {
      allow read, write: if true;
    }
  }
}

🔧 **Pasos para aplicar:**
1. Ve a: https://console.firebase.google.com/
2. Selecciona proyecto: gestiondepedidos-ebd1e
3. Ve a Firestore Database
4. Clic en "Reglas" (Rules)
5. Borra todo y pega el código de arriba
6. Clic en "Publicar"

⚠️ **IMPORTANTE:** 
Estas reglas permiten acceso sin autenticación para que la app funcione en cualquier computadora.
Para un entorno de producción real, considera implementar autenticación.

✅ **Una vez configurado, la app funcionará perfectamente en cualquier dispositivo!**
            `;
            
            alert(rules);
        }

        // Initialize Firebase when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Inicializando aplicación...');
            
            try {
                // Load configuration
                console.log('📝 Cargando configuración...');
                
                // Wait for firebaseService to be ready
                let attempts = 0;
                while (!window.firebaseService && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (window.firebaseService) {
                    console.log('🔥 Firebase service detectado');
                    
                    // Wait for Firebase to initialize
                    let initAttempts = 0;
                    while (!window.firebaseService.isInitialized && initAttempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        initAttempts++;
                    }
                    
                    if (window.firebaseService.isInitialized) {
                        console.log('✅ Firebase inicializado correctamente');
                        
                        // Load orders from Firebase
                        await loadOrdersFromFirebase();
                        
                        // Setup real-time listener if available
                        if (FIREBASE_CONFIG.REAL_TIME) {
                            console.log('👂 Configurando listener en tiempo real...');
                            window.firebaseService.subscribeToOrders((pedidos) => {
                                console.log('🔄 Pedidos actualizados en tiempo real:', pedidos.length);
                                orders = pedidos;
                                displayOrdersList();
                                displayLiquidatedOrdersList();
                            });
                        }
                    } else {
                        console.warn('⚠️ Firebase no se inicializó, usando modo offline');
                    }
                } else {
                    console.warn('⚠️ Firebase service no disponible, usando modo offline');
                }
                
                // Load orders from localStorage if Firebase is not available
                if (!window.firebaseService || !window.firebaseService.isInitialized) {
                    console.log('📋 Cargando pedidos desde localStorage...');
                    loadOrders();
                    
                    // Load orders from Google Sheets if available
                    if (GOOGLE_CONFIG.ENABLED) {
                        console.log('📊 Sincronizando pedidos desde Google Sheets...');
                        await loadOrdersFromGoogleSheets();
                    }
                    
                    // Display orders after loading
                    displayOrdersList();
                    displayLiquidatedOrdersList();
                    console.log(`📋 Se cargaron ${orders.length} pedidos en total`);
                }
                
                // Load products from Firebase first, then fallback
                console.log('📦 Cargando productos...');
                if (window.firebaseService && window.firebaseService.isInitialized) {
                    console.log('🔥 Intentando cargar productos desde Firebase...');
                    await loadProductsFromFirebase();
                } else if (GOOGLE_CONFIG.ENABLED) {
                    console.log('� Fallback: cargando productos desde Google Sheets...');
                    await loadProductsFromGoogleSheets();
                } else {
                    console.log('📦 Fallback: cargando productos por defecto...');
                    loadDefaultProducts();
                }
                
                console.log('✅ Aplicación inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando aplicación:', error);
                console.warn('⚠️ La aplicación se ejecutará en modo básico. Algunos servicios pueden no estar disponibles.');
                
                // En lugar de alert intrusivo, intentar cargar lo básico
                try {
                    loadOrders();
                    loadDefaultProducts();
                    loadProductsToSelect();
                    displayOrdersList();
                    displayLiquidatedOrdersList();
                    console.log('✅ Aplicación inicializada en modo básico');
                } catch (fallbackError) {
                    console.error('❌ Error crítico en inicialización básica:', fallbackError);
                    // Solo mostrar alert si el modo básico también falla
                    alert('⚠️ Error crítico inicializando la aplicación. Por favor, recarga la página.');
                }
            }
        });
    </script>
    
    <!-- Asegurar que todas las funciones estén disponibles -->
    <script>
        // Función global para asegurar que switchTab esté disponible inmediatamente
        if (typeof window.switchTab === 'undefined') {
            console.log('🔧 Definiendo switchTab globalmente...');
            window.switchTab = function(tabId, targetElement = null) {
                try {
                    console.log('🔄 switchTab called:', tabId);
                    
                    // Hide all tab contents
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // Show selected tab content
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                        console.log('Tab activado:', tabId);
                    } else {
                        console.error('No se encontró el tab:', tabId);
                    }
                    
                    // Add active class to clicked tab
                    if (targetElement) {
                        targetElement.classList.add('active');
                    } else {
                        // Find the tab by onclick attribute if no target provided
                        const tabButtons = document.querySelectorAll('.tab');
                        tabButtons.forEach(tab => {
                            const onclick = tab.getAttribute('onclick');
                            if (onclick && onclick.includes(tabId)) {
                                tab.classList.add('active');
                            }
                        });
                    }
                    
                } catch (error) {
                    console.error('🚨 ERROR EN switchTab:', error);
                    alert(`🚨 Error cambiando de pestaña: ${error.message}`);
                }
            };
        }
        
        // Asegurar que testStorage esté disponible
        if (typeof window.testStorage === 'undefined') {
            window.testStorage = function() {
                const results = document.getElementById('test-results');
                if (!results) {
                    alert('❌ Error: No se encontró el elemento de resultados');
                    return;
                }
                
                try {
                    results.innerHTML = '🔄 Probando LocalStorage...';
                    
                    localStorage.setItem('test_key', 'test_value');
                    const value = localStorage.getItem('test_key');
                    localStorage.removeItem('test_key');
                    
                    if (value === 'test_value') {
                        results.innerHTML = '✅ LocalStorage funciona correctamente';
                        console.log('✅ LocalStorage test exitoso');
                    } else {
                        results.innerHTML = '❌ LocalStorage no funciona correctamente';
                        console.error('❌ LocalStorage test falló');
                    }
                } catch (error) {
                    console.error('❌ Error en testStorage:', error);
                    results.innerHTML = '❌ Error en LocalStorage: ' + error.message;
                }
            };
        }
        
        // Asegurar que testGoogleSheets esté disponible
        if (typeof window.testGoogleSheets === 'undefined') {
            window.testGoogleSheets = function() {
                const results = document.getElementById('test-results');
                if (results) {
                    results.innerHTML = '⚠️ Google Sheets deshabilitado. Usando Firebase.';
                }
                console.log('⚠️ Google Sheets deshabilitado, usando Firebase');
            };
        }
        
        // Asegurar que loadProductsFromGoogleSheets esté disponible globalmente
        if (typeof window.loadProductsFromGoogleSheets === 'undefined') {
            window.loadProductsFromGoogleSheets = async function() {
                const results = document.getElementById('test-results');
                
                try {
                    console.log('📊 Cargando productos desde Google Sheets...');
                    
                    if (results) {
                        results.innerHTML = '🔄 Cargando productos desde Google Sheets...';
                    }
                    
                    const SHEETS_ID = "1yVjDyz7aXnW5BIyVoe3y7bFsrJGR3pVUwtnI43PprAg";
                    const API_KEY = "AIzaSyCfPL8M1wIFMKxBOkTPsuwAbiyEMXk8Zvw";
                    const STOCK_RANGE = "stock!A1:F1000";
                    
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_ID}/values/${STOCK_RANGE}?key=${API_KEY}`;
                    console.log('🔗 URL:', url);
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('📊 Datos recibidos de Google Sheets:', data);
                    
                    if (data.values && data.values.length > 0) {
                        // Simple product parsing
                        window.products = [];
                        const allColors = new Set();
                        
                        for (let i = 1; i < data.values.length; i++) {
                            const row = data.values[i];
                            if (row.length >= 4) {
                                const productName = (row[0] || 'Sin nombre').toString().trim();
                                const color = (row[1] || 'Sin color').toString().trim();
                                const price = parseFloat(row[3]) || 0;
                                
                                if (color && color !== 'Sin color') {
                                    allColors.add(color);
                                }
                                
                                const product = {
                                    id: 'PROD_' + i,
                                    name: productName,
                                    color: color,
                                    price: price,
                                    cost: parseFloat(row[5]) || 0,
                                    stock: parseInt(row[2]) || 0,
                                    category: (row[4] || 'General').toString().trim()
                                };
                                
                                window.products.push(product);
                            }
                        }
                        
                        window.availableColors = Array.from(allColors);
                        console.log(`✅ ${window.products.length} productos cargados desde Google Sheets`);
                        
                        // ⭐ CRÍTICO: Sincronizar con la variable global products
                        products = window.products;
                        console.log('🔄 Variables sincronizadas - products:', products.length, 'window.products:', window.products.length);
                        
                        if (results) {
                            results.innerHTML = `✅ Inventario actualizado desde Google Sheets!<br>📊 Se cargaron ${products.length} productos`;
                        }
                        
                        // Update product selects
                        const datalists = document.querySelectorAll('[id$="productos-datalist"]');
                        datalists.forEach((datalist) => {
                            datalist.innerHTML = '';
                            const uniqueProducts = [];
                            const seenNames = new Set();
                            
                            products.forEach(product => { // Usar la variable products sincronizada
                                if (!seenNames.has(product.name)) {
                                    seenNames.add(product.name);
                                    uniqueProducts.push(product);
                                }
                            });
                            
                            console.log(`🔄 Poblando datalist con ${uniqueProducts.length} productos únicos`);
                            
                            uniqueProducts.forEach(product => {
                                const option = document.createElement('option');
                                option.value = product.name;
                                datalist.appendChild(option);
                            });
                            
                            console.log(`✅ Datalist poblado con ${datalist.children.length} opciones`);
                        });
                        
                    } else {
                        console.warn('⚠️ No hay datos en Google Sheets');
                        if (results) {
                            results.innerHTML = '⚠️ No hay datos en Google Sheets';
                        }
                    }
                    
                } catch (error) {
                    console.error('❌ Error cargando desde Google Sheets:', error);
                    if (results) {
                        results.innerHTML = `❌ Error conectando con Google Sheets: ${error.message}`;
                    }
                }
            };
        }
        
        // Asegurar que forceLoadFromGoogleSheets esté disponible globalmente
        if (typeof window.forceLoadFromGoogleSheets === 'undefined') {
            window.forceLoadFromGoogleSheets = async function() {
                const results = document.getElementById('test-results');
                if (results) {
                    results.innerHTML = '🔄 Forzando carga completa desde Google Sheets...';
                }
                
                try {
                    console.log('🔄 FORZANDO carga completa de productos desde Google Sheets...');
                    console.log('📊 Productos antes de la carga:', (window.products || []).length);
                    
                    // Limpiar productos actuales
                    window.products = [];
                    products = []; // ⭐ También limpiar la variable global products
                    
                    // Llamar a la función de carga
                    await window.loadProductsFromGoogleSheets();
                    
                    // ⭐ CRÍTICO: Sincronizar ambas variables después de la carga
                    if (window.products && window.products.length > 0) {
                        products = window.products;
                        console.log('� SINCRONIZACIÓN: products y window.products sincronizados con', products.length, 'productos');
                    }
                    
                    console.log('�📊 Productos después de la carga:', (window.products || []).length);
                    console.log('📊 Variable products:', products.length);
                    
                    // ⭐ FORZAR actualización inmediata de los dropdowns
                    setTimeout(() => {
                        console.log('🔄 Forzando actualización de dropdowns con', products.length, 'productos...');
                        if (typeof loadProductsToSelect === 'function') {
                            loadProductsToSelect();
                        } else {
                            console.warn('⚠️ loadProductsToSelect no está disponible');
                        }
                    }, 200);
                    
                    // Verificar que los productos se hayan cargado
                    if (products.length > 0) {
                        const message = `
                            <div style="background: #10b981; color: white; padding: 12px; border-radius: 6px;">
                                ✅ <strong>Carga completa exitosa</strong><br>
                                📦 ${products.length} productos cargados desde Google Sheets<br>
                                🎨 ${(window.availableColors || []).length} colores disponibles<br>
                                🔄 Selectores de productos actualizados
                            </div>
                        `;
                        if (results) results.innerHTML = message;
                    } else {
                        throw new Error('No se cargaron productos desde Google Sheets');
                    }
                    
                } catch (error) {
                    console.error('❌ Error en carga forzada:', error);
                    const message = `
                        <div style="background: #dc2626; color: white; padding: 12px; border-radius: 6px;">
                            ❌ <strong>Error en carga forzada</strong><br>
                            📝 ${error.message}<br>
                            💡 Revisa la consola para más detalles
                        </div>
                    `;
                    if (results) results.innerHTML = message;
                }
            };
        }
        
        // Asegurar que debugGoogleSheetsProducts esté disponible
        if (typeof window.debugGoogleSheetsProducts === 'undefined') {
            window.debugGoogleSheetsProducts = async function() {
                const results = document.getElementById('test-results');
                if (results) {
                    results.innerHTML = '🔍 Depurando datos de Google Sheets...';
                }
                
                try {
                    console.log('� DEBUG: Iniciando depuración de Google Sheets');
                    const SHEETS_ID = "1yVjDyz7aXnW5BIyVoe3y7bFsrJGR3pVUwtnI43PprAg";
                    const API_KEY = "AIzaSyCfPL8M1wIFMKxBOkTPsuwAbiyEMXk8Zvw";
                    const STOCK_RANGE = "stock!A1:F1000";
                    
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_ID}/values/${STOCK_RANGE}?key=${API_KEY}`;
                    console.log('🔗 URL completa:', url);
                    
                    const response = await fetch(url);
                    console.log('📡 Status de respuesta:', response.status);
                    
                    const data = await response.json();
                    console.log('📊 Datos completos recibidos:', data);
                    
                    if (data.values) {
                        console.log(`📋 Total de filas: ${data.values.length}`);
                        console.log('📋 Primeras 5 filas:', data.values.slice(0, 5));
                        console.log('📋 Headers (fila 1):', data.values[0]);
                        
                        // Contar productos válidos
                        let validProducts = 0;
                        for (let i = 1; i < data.values.length; i++) {
                            const row = data.values[i];
                            if (row.length >= 3 && row[0]) { // Tiene código y al menos 3 columnas
                                validProducts++;
                            }
                        }
                        
                        const message = `
                            <div style="background: #10b981; color: white; padding: 12px; border-radius: 6px;">
                                ✅ <strong>Depuración exitosa</strong><br>
                                📊 Total de filas en hoja: ${data.values.length}<br>
                                📦 Productos válidos encontrados: ${validProducts}<br>
                                📋 Rango usado: ${STOCK_RANGE}<br>
                                🎨 Revisa la consola (F12) para más detalles
                            </div>
                        `;
                        
                        if (results) results.innerHTML = message;
                        
                        alert(`✅ Debug completado!\n📊 ${data.values.length} filas totales\n📦 ${validProducts} productos válidos\nRevisa la consola para más detalles.`);
                        
                    } else {
                        throw new Error('No se recibieron datos de la hoja');
                    }
                    
                } catch (error) {
                    console.error('❌ Error en debug:', error);
                    const message = `
                        <div style="background: #dc2626; color: white; padding: 12px; border-radius: 6px;">
                            ❌ <strong>Error en depuración</strong><br>
                            📝 ${error.message}<br>
                            💡 Verifica que la hoja sea pública y el rango sea correcto
                        </div>
                    `;
                    if (results) results.innerHTML = message;
                    alert(`❌ Error en debug: ${error.message}`);
                }
            };
        }
        
        console.log('�🔧 Funciones de respaldo definidas');
        console.log('- switchTab:', typeof window.switchTab);
        console.log('- testStorage:', typeof window.testStorage);
        console.log('- testGoogleSheets:', typeof window.testGoogleSheets);
        console.log('- debugGoogleSheetsProducts:', typeof window.debugGoogleSheetsProducts);
    </script>
    
    <!-- Firebase Configuration -->
    <script src="js/config.js"></script>
    
    <!-- Firebase Setup Instructions -->
    <script src="firebase-setup-instructions.js"></script>
    
    <!-- Firebase Service -->
    <script type="module" src="js/firebase-new.js"></script>
    
    <!-- Script de inicialización con Google Sheets como método principal -->
    <script>
        // Override the initialization to use Google Sheets first with forced loading
        window.addEventListener('load', async function() {
            console.log('🌟 Inicialización automática con carga forzada desde Google Sheets...');
            
            // Load orders from localStorage
            loadOrders();
            
            // Auto-load products using forced method (the one that works)
            if (GOOGLE_CONFIG.ENABLED) {
                console.log('� CARGA AUTOMÁTICA: Ejecutando forceLoadFromGoogleSheets...');
                try {
                    await forceLoadFromGoogleSheets();
                    lastProductLoad = Date.now(); // Mark when products were loaded
                    console.log('✅ Carga automática completada exitosamente - todos los productos disponibles');
                    
                    // ⭐ CRÍTICO: Forzar actualización de los dropdowns después de la carga automática
                    console.log('🔄 FORZANDO actualización de dropdowns después de carga automática...');
                    
                    // ⭐ SINCRONIZACIÓN CRÍTICA: Asegurar que products y window.products estén sincronizados
                    if (window.products && window.products.length > 0) {
                        products = window.products; // Sincronizar variable global
                        console.log('🔄 Variables sincronizadas - products:', products.length, 'window.products:', window.products.length);
                    }
                    
                    setTimeout(() => {
                        console.log('🔄 Ejecutando loadProductsToSelect con', products.length, 'productos...');
                        loadProductsToSelect();
                        console.log('✅ Dropdowns actualizados automáticamente');
                    }, 500);
                    
                    // Diagnóstico detallado para depuración
                    console.log('🔍 DIAGNÓSTICO POST-CARGA:');
                    console.log('- window.products array:', window.products ? window.products.length : 'undefined');
                    console.log('- localStorage currentProducts:', localStorage.getItem('currentProducts') ? JSON.parse(localStorage.getItem('currentProducts')).length : 'null');
                    
                    // Verificar datalist de productos
                    const modelDatalist = document.getElementById('productos-datalist');
                    console.log('- productos-datalist:', modelDatalist ? modelDatalist.children.length : 'no encontrado');
                    
                    // Mostrar los primeros 5 productos en el datalist
                    if (modelDatalist && modelDatalist.children.length > 0) {
                        console.log('- Primeros 5 productos en datalist:');
                        for (let i = 0; i < Math.min(5, modelDatalist.children.length); i++) {
                            console.log(`  ${i+1}. ${modelDatalist.children[i].value}`);
                        }
                    }
                    
                    // Verificar productos únicos
                    if (window.products) {
                        const uniqueModels = [...new Set(window.products.map(p => p.name))]; // Usar 'name' en lugar de 'model'
                        console.log('- Modelos únicos encontrados:', uniqueModels.length);
                        console.log('- Primeros 5 modelos únicos:', uniqueModels.slice(0, 5));
                    }
                } catch (error) {
                    console.error('❌ Error en carga automática:', error);
                    console.log('📦 Fallback: cargando productos por defecto...');
                    loadDefaultProducts();
                    lastProductLoad = Date.now(); // Mark even default products load
                }
            } else {
                console.log('📦 Google Sheets deshabilitado, cargando productos por defecto...');
                loadDefaultProducts();
                lastProductLoad = Date.now();
            }
            
            // Update configuration display
            updateConfigStatus();
            
            console.log('🎉 Inicialización automática completada - aplicación lista para usar');
            console.log('📊 Productos cargados:', products.length);
        });
    </script>
</body>
</html>
